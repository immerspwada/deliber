# Implementation Plan: Admin Panel Complete Verification and Database Setup

## Overview

This implementation plan breaks down the complete verification and database setup for the Admin Panel into discrete, manageable tasks. The plan follows an incremental approach, starting with database verification, then creating missing RPC functions, followed by frontend integration and testing.

## Tasks

- [x] 1. Database Schema Verification and Setup
  - Verify all required tables exist with correct schemas
  - Create missing indexes for performance optimization
  - Verify foreign key constraints and relationships
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 1.1 Write property test for database schema verification
  - **Property 1: Required Tables Existence**
  - **Property 2: Schema Correctness**
  - **Property 3: Foreign Key Integrity**
  - **Property 4: Performance Indexes**
  - **Validates: Requirements 1.1, 1.2, 1.3, 1.4**

- [x] 2. Create Missing RPC Functions (Priority 1 - Critical)
  - [x] 2.1 Create get_admin_customers() RPC function
    - Function to retrieve customer list with filters and search
    - Parameters: search_term, status, limit, offset
    - Returns TABLE with customer details including wallet balance and order stats
    - Include SECURITY DEFINER and admin role check
    - _Requirements: 2.2_
  - [x] 2.2 Create get_admin_providers_v2() RPC function
    - Function to retrieve provider list with status and verification info
    - Parameters: status, provider_type, limit, offset
    - Returns TABLE with provider details including documents and earnings
    - Include SECURITY DEFINER and admin role check
    - Use dual-role pattern (providers_v2.user_id)
    - _Requirements: 2.3_
  - [x] 2.3 Create migration file for Priority 1 RPC functions
    - Create migration file: 297_admin_priority1_rpc_functions.sql
    - Include DROP FUNCTION IF EXISTS statements
    - Add comprehensive comments
    - Test functions with sample queries
    - _Requirements: 2.2, 2.3, 17.2, 17.3, 17.4_

- [x] 2.4 Write unit tests for Priority 1 RPC functions
  - Test get_admin_customers() returns expected data format
  - Test get_admin_providers_v2() returns expected data format
  - Test functions handle filters correctly
  - Test functions require admin role
  - _Requirements: 2.2, 2.3_

- [x] 3. Create Missing RPC Functions (Priority 2 - Important)
  - [x] 3.1 Create get_scheduled_rides() RPC function
    - Function to retrieve scheduled rides for future dates
    - Parameters: date_from, date_to, limit, offset
    - Returns TABLE with scheduled ride details
    - Filter for rides with scheduled_time > NOW()
    - _Requirements: 3.3_
  - [x] 3.2 Create get_provider_withdrawals_admin() RPC function
    - Function to retrieve provider withdrawal requests
    - Parameters: status, limit, offset
    - Returns TABLE with withdrawal details including bank info
    - Join with providers_v2 for provider details
    - _Requirements: 3.4_
  - [x] 3.3 Create get_topup_requests_admin() RPC function
    - Function to retrieve customer topup requests
    - Parameters: status, limit, offset
    - Returns TABLE with topup details including payment proof
    - Join with users for customer details
    - _Requirements: 3.5_
  - [x] 3.4 Create migration file for Priority 2 RPC functions
    - Create migration file: 298_admin_priority2_rpc_functions.sql
    - Include DROP FUNCTION IF EXISTS statements
    - Add comprehensive comments
    - Test functions with sample queries
    - _Requirements: 3.3, 3.4, 3.5, 17.2, 17.3, 17.4_

- [x] 3.5 Write unit tests for Priority 2 RPC functions
  - Test get_scheduled_rides() filters future dates correctly
  - Test get_provider_withdrawals_admin() returns withdrawal data
  - Test get_topup_requests_admin() returns topup data
  - _Requirements: 3.3, 3.4, 3.5_

- [x] 4. Create Missing RPC Functions (Priority 3 - Analytics)
  - [x] 4.1 Create get_admin_revenue_stats() RPC function
    - Function to calculate revenue statistics with date ranges
    - Parameters: date_from, date_to, service_type
    - Returns JSON with revenue breakdown by service type
    - Include daily breakdown and payment method breakdown
    - _Requirements: 4.1_
  - [x] 4.2 Create get_admin_payment_stats() RPC function
    - Function to calculate payment statistics and trends
    - Parameters: date_from, date_to
    - Returns JSON with payment analytics
    - Include transaction counts and amounts by payment method
    - _Requirements: 4.2_
  - [x] 4.3 Create migration file for Priority 3 RPC functions
    - Create migration file: 299_admin_priority3_rpc_functions.sql
    - Include DROP FUNCTION IF EXISTS statements
    - Add comprehensive comments
    - Test functions with sample queries
    - _Requirements: 4.1, 4.2, 17.2, 17.3, 17.4_

- [x] 4.4 Write unit tests for Priority 3 RPC functions
  - Test get_admin_revenue_stats() calculates correctly
  - Test get_admin_payment_stats() returns analytics
  - Test date range filtering works correctly
  - _Requirements: 4.1, 4.2_

- [x] 5. Checkpoint - Database Functions Complete
  - Ensure all migrations applied successfully
  - Verify all 15 RPC functions exist and work
  - Run security advisor to check for issues
  - Run performance advisor to check for missing indexes
  - Generate TypeScript types from database schema
  - Ask user if any questions arise

- [x] 6. Verify and Update RLS Policies
  - [x] 6.1 Verify admin RLS policies on all tables
    - Check that admin policies exist on all tables
    - Verify policies use SELECT wrapper pattern for auth.uid()
    - Verify policies check profiles.role = 'admin'
    - Update policies that don't follow best practices
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 15.3_
  - [x] 6.2 Verify dual-role RLS policies for providers
    - Check provider policies use providers_v2.user_id pattern
    - Verify no policies directly compare provider_id with auth.uid()
    - Update policies that don't follow dual-role pattern
    - _Requirements: 6.1, 6.2, 6.3_
  - [x] 6.3 Create migration file for RLS policy updates
    - Create migration file: 300_admin_rls_policy_verification.sql
    - Include DROP POLICY IF EXISTS statements
    - Add comprehensive comments explaining changes
    - Test policies with different user roles
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 17.2, 17.3, 17.4_

- [x] 6.4 Write property tests for RLS policies
  - **Property 5: Admin Full Access**
  - **Property 6: Admin Role Verification**
  - **Property 7: SELECT Wrapper Optimization**
  - **Property 8: Non-Admin Access Denial**
  - **Property 9: RLS Enabled on All Tables**
  - **Property 10: Provider Query Join Pattern**
  - **Property 11: No Direct Provider ID Comparison**
  - **Validates: Requirements 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 15.1, 15.4**

- [x] 7. Create Admin Composables for New RPC Functions
  - [x] 7.1 Create useAdminCustomers composable
    - Implement fetchCustomers() with filters and search
    - Implement suspendCustomer() and unsuspendCustomer()
    - Handle loading and error states
    - Implement pagination
    - _Requirements: 8.1, 8.2_
  - [x] 7.2 Create useAdminProviders composable
    - Implement fetchProviders() with filters
    - Implement approveProvider() and rejectProvider()
    - Handle loading and error states
    - Implement pagination
    - _Requirements: 8.3, 8.4_
  - [x] 7.3 Create useAdminScheduledRides composable
    - Implement fetchScheduledRides() with date filters
    - Handle loading and error states
    - Implement pagination
    - _Requirements: 9.5_
  - [x] 7.4 Create useAdminWithdrawals composable (if not exists)
    - Implement fetchWithdrawals() with status filter
    - Implement approveWithdrawal() and rejectWithdrawal()
    - Handle loading and error states
    - Implement pagination
    - _Requirements: 10.4, 10.5_
  - [x] 7.5 Create useAdminTopup composable (if not exists)
    - Implement fetchTopupRequests() with status filter
    - Implement approveTopup() and rejectTopup()
    - Handle loading and error states
    - Implement pagination
    - _Requirements: 10.6, 10.7_
  - [x] 7.6 Create useAdminRevenue composable
    - Implement fetchRevenueStats() with date range
    - Handle loading and error states
    - Format data for charts
    - _Requirements: 10.1, 10.2_
  - [x] 7.7 Create useAdminPayments composable
    - Implement fetchPaymentStats() with date range
    - Handle loading and error states
    - Format data for analytics display
    - _Requirements: 10.3_

- [x] 7.8 Write unit tests for admin composables
  - Test each composable's fetch functions
  - Test error handling
  - Test loading states
  - Test pagination
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 9.5, 10.1-10.7_

- [x] 8. Update Admin Views to Use New Composables
  - [x] 8.1 Update AdminCustomersView.vue
    - Integrate useAdminCustomers composable
    - Add search and filter UI
    - Add suspend/unsuspend actions
    - Display customer details and stats
    - _Requirements: 8.1, 8.2_
  - [x] 8.2 Update AdminProvidersView.vue
    - Integrate useAdminProviders composable
    - Add status and type filters
    - Add approve/reject actions
    - Display provider details and documents
    - _Requirements: 8.3, 8.4_
  - [x] 8.3 Update AdminVerificationQueueView.vue
    - Use useAdminProviders with status='pending' filter
    - Add document review UI
    - Add approve/reject with notes
    - _Requirements: 8.5_
  - [x] 8.4 Update AdminScheduledRidesView.vue
    - Integrate useAdminScheduledRides composable
    - Add date range filters
    - Display scheduled ride details
    - _Requirements: 9.5_
  - [x] 8.5 Update AdminWithdrawalsView.vue
    - Integrate useAdminWithdrawals composable (currently uses old pattern)
    - Add status filter
    - Add approve/reject actions with bank details
    - _Requirements: 10.4, 10.5_
  - [x] 8.6 Create AdminTopupRequestsView.vue
    - Integrate useAdminTopupRequests composable
    - Add status filter
    - Add approve/reject actions
    - Display payment proof images
    - _Requirements: 10.6, 10.7_
  - [x] 8.7 Update AdminRevenueView.vue
    - Integrate useAdminRevenue composable
    - Add date range picker
    - Add revenue charts (line chart, pie chart)
    - Display breakdown by service type
    - _Requirements: 10.1, 10.2_
  - [x] 8.8 Update AdminPaymentsView.vue
    - Integrate useAdminPayments composable
    - Add date range picker
    - Display payment statistics
    - Add payment method breakdown
    - _Requirements: 10.3_

- [x] 8.9 Write component tests for updated admin views
  - Test each view renders correctly
  - Test filters and search work
  - Test actions trigger correctly
  - Test pagination works
  - _Requirements: 8.1-8.6, 9.5, 10.1-10.7_

- [x] 9. Checkpoint - Frontend Integration Complete
  - Ensure all admin views load without errors
  - Verify all composables work correctly
  - Test all CRUD operations
  - Check error handling and loading states
  - Ask user if any questions arise

- [x] 10. Implement Real-Time Features
  - [x] 10.1 Add real-time updates to AdminDashboardView
    - Subscribe to ride_requests changes for active orders
    - Subscribe to providers_v2 changes for online providers
    - Update statistics every 30 seconds
    - _Requirements: 13.2, 13.3_
  - [x] 10.2 Add real-time updates to AdminDriverTrackingView
    - Subscribe to provider_location_history for real-time locations
    - Update map markers when provider locations change
    - _Requirements: 13.1_
  - [x] 10.3 Add real-time updates to AdminOrdersView (via useAdminRealtime)
    - Subscribe to ride_requests, delivery_requests, shopping_requests
    - Show notification when new orders arrive
    - Update order list when status changes
    - _Requirements: 13.3, 13.4_
  - [x] 10.4 Add real-time updates to AdminProvidersView
    - Subscribe to providers_v2 changes
    - Update provider list when status or online status changes
    - _Requirements: 13.4_

- [x] 10.5 Write tests for real-time features
  - Test subscriptions are created correctly
  - Test updates trigger UI changes
  - Test subscriptions are cleaned up on unmount
  - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5_

- [x] 11. Implement Error Handling and User Feedback
  - [x] 11.1 Add error handling to all admin composables
    - Wrap all RPC calls in try-catch
    - Use useErrorHandler for consistent error handling
    - Display user-friendly error messages
    - Log errors to console for debugging
    - _Requirements: 16.1, 16.2, 16.5_
  - [x] 11.2 Add success confirmations to all actions
    - Show toast notification on successful operations
    - Include action details in confirmation message
    - Auto-dismiss after 3 seconds
    - _Requirements: 16.4_
  - [x] 11.3 Add retry functionality for network errors
    - Detect network failures
    - Display retry button
    - Implement exponential backoff for automatic retries
    - _Requirements: 16.3_

- [x] 11.4 Write property tests for error handling
  - **Property 15: User-Friendly Error Messages**
  - **Property 16: RPC Error Display**
  - **Property 17: Network Failure Retry**
  - **Property 18: Success Confirmation**
  - **Property 19: Error Logging**
  - **Validates: Requirements 16.1, 16.2, 16.3, 16.4, 16.5**

- [x] 12. Implement Input Validation
  - [x] 12.1 Add Zod schemas for all admin forms
    - Create schemas for customer suspension
    - Create schemas for provider approval/rejection
    - Create schemas for withdrawal approval
    - Create schemas for topup approval
    - _Requirements: 15.5_
  - [x] 12.2 Integrate validation into admin composables
    - Validate inputs before RPC calls
    - Display validation errors to user
    - Prevent submission of invalid data
    - _Requirements: 15.5_

- [x] 12.3 Write property test for input validation
  - **Property 14: Input Validation Before Database Operations**
  - **Validates: Requirements 15.5**

- [x] 13. Implement Audit Logging
  - [x] 13.1 Create audit_logs table
    - Columns: id, timestamp, user_id, action, resource_type, resource_id, changes, ip_address, user_agent
    - Add indexes on user_id and timestamp
    - Enable RLS for admin-only access
    - _Requirements: 15.2_
    - _Note: Multiple audit log tables exist (admin_audit_logs, security_audit_log, etc.)_
  - [x] 13.2 Add audit logging to sensitive operations
    - Log provider approval/rejection
    - Log customer suspension
    - Log withdrawal approval
    - Log topup approval
    - Log settings changes
    - _Requirements: 15.2_
  - [x] 13.3 Create migration file for audit logging (if needed)
    - Review existing audit log tables (migrations 081, 228, etc.)
    - Consolidate or extend existing audit logging
    - Add helper function for creating audit logs
    - _Requirements: 15.2, 17.2, 17.3, 17.4_

- [x] 13.4 Write property test for audit logging
  - **Property 24: Sensitive Operation Logging**
  - **Validates: Requirements 15.2**

- [x] 14. Implement Pagination for All List Views
  - [x] 14.1 Add pagination component
    - Create reusable AdminPagination.vue component
    - Support page size selection (10, 20, 50, 100)
    - Display total count and current page
    - _Requirements: 14.4_
  - [x] 14.2 Integrate pagination into all list views
    - Add pagination to AdminCustomersView (already has basic pagination)
    - Add pagination to AdminProvidersView (already has basic pagination)
    - Add pagination to AdminOrdersView
    - Add pagination to all other list views
    - _Requirements: 14.4_

- [x] 14.3 Write property test for pagination
  - **Property 20: List Pagination**
  - **Validates: Requirements 14.4**

- [x] 15. Checkpoint - All Features Complete
  - Ensure all 20 admin routes load without errors
  - Verify all RPC functions work correctly
  - Test all CRUD operations
  - Test real-time features
  - Test error handling
  - Test input validation
  - Test audit logging
  - Test pagination
  - Ask user if any questions arise

- [x] 16. Production Deployment - Apply Migration 301
  - [x] 16.1 Apply migration 301 to production database
    - **CRITICAL**: Migration 301 fixes admin RPC functions to check `users` table instead of `profiles`
    - **Current Issue**: Admin providers page shows 404 errors in production
    - **Production URL**: https://onsflqhkgqhydeupiqyt.supabase.co
    - **Recommended Method**: Supabase Dashboard SQL Editor
    - **Alternative**: `npx supabase db push --linked` (requires project link)
    - **See**: PRODUCTION-DEPLOYMENT.md for detailed instructions
    - _Requirements: 17.1, 17.2, 17.3, 17.4_
  - [x] 16.2 Verify RPC functions exist in production
    - Run verification query in Supabase Dashboard
    - Check that all 4 functions exist: get_admin_providers_v2, count_admin_providers_v2, get_admin_customers, count_admin_customers
    - Test functions return data correctly
    - _Requirements: 17.1, 17.2_
  - [x] 16.3 Test admin providers page in production
    - Navigate to http://localhost:5173/admin/providers
    - Verify page loads without 404 errors
    - Verify provider list displays
    - Verify real-time indicator shows "Live"
    - Test filters and pagination
    - _Requirements: 8.3, 8.4, 13.4_
  - [x] 16.4 Verify admin user role in production
    - Check that superadmin@gobear.app has role = 'super_admin' in users table
    - If not, update role using SQL in Supabase Dashboard
    - Test login and access to admin panel
    - _Requirements: 5.1, 5.2_

- [x] 17. Comprehensive Testing
  - [x] 17.1 Run all property-based tests
    - Execute all property tests with 100 iterations
    - Verify all properties pass
    - Fix any failing properties
    - _Requirements: 18.2_
    - _Command: `npx vitest run src/tests/admin-*.property.test.ts`_
    - _Status: 19 property test files created, ready to execute_
  - [x] 17.2 Run all unit tests
    - Execute all unit tests
    - Verify all tests pass
    - Achieve 80% code coverage
    - _Requirements: 18.1_
    - _Command: `npx vitest run src/tests/admin-*.unit.test.ts`_
    - _Status: 13 unit test files created, ready to execute_
  - [x] 17.3 Perform manual testing of all routes
    - Test all 20 admin routes
    - Verify data displays correctly
    - Test all filters and search
    - Test all CRUD operations
    - _Requirements: 18.1_
    - _Manual Testing Checklist:_
      - [ ] /admin/dashboard - Dashboard loads with statistics
      - [ ] /admin/customers - Customer list with search/filter
      - [ ] /admin/providers - Provider list with approve/reject
      - [ ] /admin/verification-queue - Document review
      - [ ] /admin/orders - All orders with filters
      - [ ] /admin/delivery - Delivery orders only
      - [ ] /admin/shopping - Shopping orders only
      - [ ] /admin/driver-tracking - Real-time map
      - [ ] /admin/scheduled-rides - Future bookings
      - [ ] /admin/revenue - Revenue charts
      - [ ] /admin/payments - Payment transactions
      - [ ] /admin/withdrawals - Withdrawal requests
      - [ ] /admin/topup-requests - Topup requests
      - [ ] /admin/promos - Promo code management
      - [ ] /admin/analytics - Usage statistics
      - [ ] /admin/push-analytics - Push notification metrics
      - [ ] /admin/cron-jobs - Cron job monitoring
      - [ ] /admin/provider-heatmap - Location heatmap
      - [ ] /admin/settings - System configuration
      - [ ] /admin/system-health - System logs
  - [x] 17.4 Run security advisor
    - Check for RLS policy issues
    - Verify no tables are exposed without policies
    - Fix any security issues found
    - _Requirements: 18.2_
    - _Use MCP: `kiroPowers(action="use", powerName="supabase-local", serverName="supabase", toolName="get_advisors", arguments={"advisor": "security"})`_
  - [x] 17.5 Run performance advisor
    - Check for missing indexes
    - Verify query performance
    - Fix any performance issues found
    - _Requirements: 18.5_
    - _Use MCP: `kiroPowers(action="use", powerName="supabase-local", serverName="supabase", toolName="get_advisors", arguments={"advisor": "performance"})`_

- [x] 18. Documentation and Cleanup
  - [x] 18.1 Update README with admin panel documentation
    - Add Admin Panel section to README.md
    - Document all 20 admin routes with descriptions
    - Document all 15 RPC functions with parameters
    - Document RLS policies and security model
    - Document dual-role system architecture
    - Add admin setup instructions
    - _Requirements: 19.1, 19.2, 19.3, 19.4_
    - _Note: docs/admin-rpc-functions.md exists, integrate into README.md_
    - _Current README: Basic project info only, needs admin section_
  - [x] 18.2 Create troubleshooting guide
    - Document common issues and solutions
    - Document error messages and fixes
    - Document performance optimization tips
    - Add debugging guide for RLS policies
    - Add guide for dual-role system issues
    - _Requirements: 19.5_
    - _Create: docs/admin-troubleshooting.md_
  - [x] 18.3 Generate final TypeScript types
    - Run npx supabase gen types --local
    - Verify types match current schema
    - Commit updated types to repository
    - _Requirements: 20.4_
    - _Command: `npx supabase gen types --local > src/types/database.ts`_
  - [x] 18.4 Clean up console logs and debug code
    - Remove unnecessary console.log statements from admin code
    - Remove debug code and commented code
    - Ensure production-ready code quality
    - _Requirements: 16.5_
    - _Found: 50+ console.log statements in src/admin/ directory_
    - _Priority files:_
      - src/admin/views/DashboardView.vue
      - src/admin/views/OrdersView.vue
      - src/admin/views/LoginView.vue
      - src/admin/views/CancellationsView.vue
      - src/admin/stores/adminAuth.store.ts
      - src/admin/composables/useAuditLog.ts
      - src/admin/composables/useAdminRealtime.ts

- [x] 19. Final Checkpoint - Deployment Ready
  - [ ] All migrations applied successfully (297-300)
  - [ ] All RPC functions created and tested (15 functions)
  - [ ] All RLS policies verified (migration 300)
  - [ ] All admin routes functional (20 routes)
  - [ ] All tests passing (32 test files)
  - [ ] Security advisor clean
  - [ ] Performance advisor clean
  - [ ] Documentation complete (README + troubleshooting guide)
  - [ ] Console logs removed from production code
  - [ ] TypeScript types generated and committed
  - [ ] Ready for production deployment

## Notes

- All tasks are required for comprehensive implementation
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- Use MCP Supabase power for all database operations
- Follow dual-role system pattern for all provider-related queries
- Use SELECT wrapper pattern in all RLS policies for performance
- Generate TypeScript types after each migration
