# ğŸ”„ Integration Flow Diagrams - Thai Ride App

**Visual representation of how all services integrate with supporting systems**

---

## ğŸ“Š Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         THAI RIDE APP ECOSYSTEM                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  CUSTOMER   â”‚  â”‚  PROVIDER   â”‚  â”‚    ADMIN    â”‚                    â”‚
â”‚  â”‚   (User)    â”‚  â”‚  (Driver/   â”‚  â”‚ (Dashboard) â”‚                    â”‚
â”‚  â”‚             â”‚  â”‚   Rider)    â”‚  â”‚             â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                â”‚                â”‚                            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                          â”‚                                             â”‚
â”‚                          â–¼                                             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚         â”‚     CORE SERVICES (6)              â”‚                         â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
â”‚         â”‚ ğŸš— Ride    ğŸ“¦ Delivery  ğŸ›’ Shoppingâ”‚                         â”‚
â”‚         â”‚ ğŸ« Queue   ğŸšš Moving    ğŸ‘” Laundry â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                      â”‚                                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚         â”‚                                    â”‚                         â”‚
â”‚         â–¼                                    â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  SUPPORTING  â”‚                    â”‚   DATABASE   â”‚                 â”‚
â”‚  â”‚   SYSTEMS    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  (Supabase)  â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ ğŸ’° Wallet    â”‚                    â”‚ PostgreSQL   â”‚                 â”‚
â”‚  â”‚ ğŸ Loyalty   â”‚                    â”‚ + Realtime   â”‚                 â”‚
â”‚  â”‚ ğŸ« Promos    â”‚                    â”‚ + Storage    â”‚                 â”‚
â”‚  â”‚ ğŸ”” Push      â”‚                    â”‚ + Functions  â”‚                 â”‚
â”‚  â”‚ ğŸ“Š Analytics â”‚                    â”‚ + RLS        â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš— Ride Service - Complete Integration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RIDE SERVICE INTEGRATION FLOW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  CUSTOMER                    SYSTEM                    PROVIDER         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
â”‚                                                                         â”‚
â”‚  1. Create Ride                                                         â”‚
â”‚     â”œâ”€ Select pickup                                                    â”‚
â”‚     â”œâ”€ Select dropoff                                                   â”‚
â”‚     â”œâ”€ Apply promo â”€â”€â”€â”€â”€â”€â†’ validate_promo_code()                        â”‚
â”‚     â””â”€ Confirm                                                          â”‚
â”‚                                                                         â”‚
â”‚  2. Submit Request â”€â”€â”€â”€â”€â”€â”€â”€â†’ create_ride_atomic()                       â”‚
â”‚                              â”œâ”€ Insert ride_requests                    â”‚
â”‚                              â”œâ”€ Hold wallet funds â”€â”€â”€â”€â†’ wallet_holds    â”‚
â”‚                              â”œâ”€ Apply promo discount                    â”‚
â”‚                              â”œâ”€ Calculate final fare                    â”‚
â”‚                              â””â”€ Trigger notifications                   â”‚
â”‚                                        â”‚                                â”‚
â”‚                                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Push: New Ride  â”‚
â”‚                                        â”‚                (Nearby)        â”‚
â”‚                                        â”‚                                â”‚
â”‚  3. Wait [pending] â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Realtime Sync                    â”‚
â”‚                                                                         â”‚
â”‚                                                        4. See New Ride  â”‚
â”‚                                                           â”œâ”€ View detailsâ”‚
â”‚                                                           â”œâ”€ Check routeâ”‚
â”‚                                                           â””â”€ Accept     â”‚
â”‚                                                                         â”‚
â”‚                              5. accept_ride_atomic() â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                              â”œâ”€ Update status: matched                  â”‚
â”‚                              â”œâ”€ Assign provider                         â”‚
â”‚                              â””â”€ Trigger notifications                   â”‚
â”‚                                        â”‚                                â”‚
â”‚  6. Matched! â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Matched!       â”‚
â”‚     Push: Driver accepted              â”‚                Push: Job       â”‚
â”‚     Realtime: Driver info              â”‚                accepted        â”‚
â”‚                                        â”‚                                â”‚
â”‚  7. Track Driver â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Realtime GPS â—„â”€ Update Location â”‚
â”‚     Live map updates                   Provider sends                  â”‚
â”‚                                        location every 5s                â”‚
â”‚                                                                         â”‚
â”‚                                                        8. Start Trip    â”‚
â”‚                                                           â””â”€ Update     â”‚
â”‚                                                              status     â”‚
â”‚                                                                         â”‚
â”‚  9. In Progress â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Realtime Sync â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚     Push: Trip started                                                  â”‚
â”‚                                                                         â”‚
â”‚                                                        10. Complete Tripâ”‚
â”‚                                                            â””â”€ End trip  â”‚
â”‚                                                                         â”‚
â”‚                              11. complete_ride_atomic() â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                              â”œâ”€ Update status: completed                â”‚
â”‚                              â”œâ”€ Settle wallet hold                      â”‚
â”‚                              â”œâ”€ Award loyalty points â”€â”€â†’ add_loyalty_   â”‚
â”‚                              â”‚                           points()       â”‚
â”‚                              â”œâ”€ Update provider earnings                â”‚
â”‚                              â””â”€ Trigger notifications                   â”‚
â”‚                                        â”‚                                â”‚
â”‚  12. Completed! â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Completed!     â”‚
â”‚      Push: Trip ended                  â”‚                Earnings +à¸¿85   â”‚
â”‚      Loyalty: +8 points                â”‚                                â”‚
â”‚                                        â”‚                                â”‚
â”‚  13. Rate Driver â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Push: New      â”‚
â”‚      Submit rating                     â”‚                Rating          â”‚
â”‚      â””â”€ Insert ride_ratings            â”‚                                â”‚
â”‚                                        â”‚                                â”‚
â”‚                              14. Track Analytics                        â”‚
â”‚                              â”œâ”€ ride_created                            â”‚
â”‚                              â”œâ”€ ride_matched                            â”‚
â”‚                              â”œâ”€ ride_completed                          â”‚
â”‚                              â””â”€ ride_rated                              â”‚
â”‚                                                                         â”‚
â”‚  ADMIN (Throughout)                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  â€¢ View all rides in real-time                                          â”‚
â”‚  â€¢ Monitor status changes                                               â”‚
â”‚  â€¢ Can override/cancel/refund                                           â”‚
â”‚  â€¢ View audit log                                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° Wallet Integration - All Services

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WALLET INTEGRATION FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  SERVICE REQUEST                WALLET SYSTEM              DATABASE     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                         â”‚
â”‚  1. CREATE REQUEST                                                      â”‚
â”‚     (Ride/Delivery/                                                     â”‚
â”‚      Shopping/etc.)                                                     â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     create_*_atomic()                                                   â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Check Balance                             â”‚
â”‚          â”‚                    IF balance < amount                       â”‚
â”‚          â”‚                    THEN ROLLBACK                             â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Hold Funds                                â”‚
â”‚          â”‚                    â”œâ”€ INSERT wallet_holds â”€â”€â†’ wallet_holds  â”‚
â”‚          â”‚                    â”‚   (status: 'held')                      â”‚
â”‚          â”‚                    â”‚                                         â”‚
â”‚          â”‚                    â””â”€ UPDATE user_wallets â”€â”€â†’ user_wallets  â”‚
â”‚          â”‚                        balance -= amount                     â”‚
â”‚          â”‚                        held_amount += amount                 â”‚
â”‚          â”‚                                                              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Create Request â”€â”€â”€â”€â”€â”€â”€â”€â†’ *_requests      â”‚
â”‚                                (status: 'pending')                      â”‚
â”‚                                                                         â”‚
â”‚  2. COMPLETE REQUEST                                                    â”‚
â”‚     (Service finished)                                                  â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     complete_*_atomic()                                                 â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Settle Hold                               â”‚
â”‚          â”‚                    â”œâ”€ UPDATE wallet_holds â”€â”€â†’ wallet_holds  â”‚
â”‚          â”‚                    â”‚   status = 'settled'                    â”‚
â”‚          â”‚                    â”‚   released_at = NOW()                   â”‚
â”‚          â”‚                    â”‚                                         â”‚
â”‚          â”‚                    â””â”€ UPDATE user_wallets â”€â”€â†’ user_wallets  â”‚
â”‚          â”‚                        held_amount -= amount                 â”‚
â”‚          â”‚                        (balance unchanged)                   â”‚
â”‚          â”‚                                                              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Update Request â”€â”€â”€â”€â”€â”€â”€â”€â†’ *_requests      â”‚
â”‚                                (status: 'completed')                    â”‚
â”‚                                                                         â”‚
â”‚  3. CANCEL REQUEST                                                      â”‚
â”‚     (User cancels)                                                      â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     cancel_*_atomic()                                                   â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Release Hold (Refund)                     â”‚
â”‚          â”‚                    â”œâ”€ UPDATE wallet_holds â”€â”€â†’ wallet_holds  â”‚
â”‚          â”‚                    â”‚   status = 'released'                   â”‚
â”‚          â”‚                    â”‚   released_at = NOW()                   â”‚
â”‚          â”‚                    â”‚                                         â”‚
â”‚          â”‚                    â””â”€ UPDATE user_wallets â”€â”€â†’ user_wallets  â”‚
â”‚          â”‚                        balance += amount                     â”‚
â”‚          â”‚                        held_amount -= amount                 â”‚
â”‚          â”‚                                                              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Update Request â”€â”€â”€â”€â”€â”€â”€â”€â†’ *_requests      â”‚
â”‚                                (status: 'cancelled')                    â”‚
â”‚                                                                         â”‚
â”‚  VERIFICATION:                                                          â”‚
â”‚  â€¢ All operations are ATOMIC (all-or-nothing)                           â”‚
â”‚  â€¢ Balance + held_amount = constant during hold                         â”‚
â”‚  â€¢ No money lost or duplicated                                          â”‚
â”‚  â€¢ Audit trail in wallet_holds table                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ Loyalty Points Integration - All Services

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LOYALTY POINTS INTEGRATION FLOW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  SERVICE COMPLETION          LOYALTY SYSTEM            DATABASE         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
â”‚                                                                         â”‚
â”‚  1. Service Completed                                                   â”‚
â”‚     (Ride/Delivery/etc.)                                                â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     UPDATE *_requests                                                   â”‚
â”‚     SET status = 'completed'                                            â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ TRIGGER FIRES                             â”‚
â”‚          â”‚                    trigger_auto_add_*_points                 â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     auto_add_*_points()                                                 â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Calculate Points                          â”‚
â”‚          â”‚                    v_points = FLOOR(final_fare / 10)         â”‚
â”‚          â”‚                    (1 point per à¸¿10)                         â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Get User Tier                             â”‚
â”‚          â”‚                    SELECT tier FROM user_loyalty             â”‚
â”‚          â”‚                    WHERE user_id = ...                       â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Apply Multiplier                          â”‚
â”‚          â”‚                    Bronze: 1.0x                              â”‚
â”‚          â”‚                    Silver: 1.2x                              â”‚
â”‚          â”‚                    Gold: 1.5x                                â”‚
â”‚          â”‚                    Platinum: 2.0x                            â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Award Points                              â”‚
â”‚          â”‚                    add_loyalty_points(                       â”‚
â”‚          â”‚                      user_id,                                â”‚
â”‚          â”‚                      points,                                 â”‚
â”‚          â”‚                      'ride_completed',                       â”‚
â”‚          â”‚                      ride_id                                 â”‚
â”‚          â”‚                    )                                         â”‚
â”‚          â”‚                    â”‚                                         â”‚
â”‚          â”‚                    â”œâ”€ INSERT points_transactions             â”‚
â”‚          â”‚                    â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ points_         â”‚
â”‚          â”‚                    â”‚                         transactions    â”‚
â”‚          â”‚                    â”‚                                         â”‚
â”‚          â”‚                    â””â”€ UPDATE user_loyalty                    â”‚
â”‚          â”‚                        total_points += points                â”‚
â”‚          â”‚                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ user_loyalty    â”‚
â”‚          â”‚                                                              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Check Tier Upgrade                        â”‚
â”‚                                check_tier_upgrade(user_id)              â”‚
â”‚                                IF total_points >= next_tier_threshold   â”‚
â”‚                                THEN upgrade_tier()                      â”‚
â”‚                                                                         â”‚
â”‚  2. User Sees Points                                                    â”‚
â”‚     â”œâ”€ Push notification: "+8 points earned!"                           â”‚
â”‚     â”œâ”€ In-app badge: "ğŸ +8"                                            â”‚
â”‚     â””â”€ Loyalty card updated                                             â”‚
â”‚                                                                         â”‚
â”‚  POINTS RATES:                                                          â”‚
â”‚  â€¢ Ride: 1 point per à¸¿10                                                â”‚
â”‚  â€¢ Delivery: 1 point per à¸¿10                                            â”‚
â”‚  â€¢ Shopping: 1 point per à¸¿10                                            â”‚
â”‚  â€¢ Queue: 1 point per à¸¿10                                               â”‚
â”‚  â€¢ Moving: 1 point per à¸¿8 (higher rate!)                                â”‚
â”‚  â€¢ Laundry: 1 point per à¸¿10                                             â”‚
â”‚                                                                         â”‚
â”‚  BONUSES:                                                               â”‚
â”‚  â€¢ First order: +100 points                                             â”‚
â”‚  â€¢ Tier multiplier: 1.0x - 2.0x                                         â”‚
â”‚  â€¢ Special events: Variable                                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”” Push Notifications Integration - All Services

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PUSH NOTIFICATIONS INTEGRATION FLOW                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  EVENT TRIGGER              NOTIFICATION SYSTEM        RECIPIENTS       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                                                         â”‚
â”‚  1. Status Change                                                       â”‚
â”‚     (Any service)                                                       â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     UPDATE *_requests                                                   â”‚
â”‚     SET status = 'matched'                                              â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ TRIGGER FIRES                             â”‚
â”‚          â”‚                    notify_*_matched()                        â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     Notification Function                                               â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Get Recipients                            â”‚
â”‚          â”‚                    â”œâ”€ Customer (user_id)                     â”‚
â”‚          â”‚                    â””â”€ Provider (provider_id)                 â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Create Notification                       â”‚
â”‚          â”‚                    INSERT user_notifications                 â”‚
â”‚          â”‚                    â”œâ”€ type: 'ride_matched'                   â”‚
â”‚          â”‚                    â”œâ”€ title: 'à¸à¸šà¸„à¸™à¸‚à¸±à¸šà¹à¸¥à¹‰à¸§!'                  â”‚
â”‚          â”‚                    â”œâ”€ message: 'à¸à¸³à¸¥à¸±à¸‡à¸¡à¸²à¸£à¸±à¸šà¸„à¸¸à¸“'               â”‚
â”‚          â”‚                    â””â”€ data: { ride_id, ... }                 â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Queue Push Notification                   â”‚
â”‚          â”‚                    INSERT push_notification_queue            â”‚
â”‚          â”‚                    â”œâ”€ user_id                                â”‚
â”‚          â”‚                    â”œâ”€ title                                  â”‚
â”‚          â”‚                    â”œâ”€ body                                   â”‚
â”‚          â”‚                    â”œâ”€ data                                   â”‚
â”‚          â”‚                    â””â”€ status: 'pending'                      â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     Push Worker                                                         â”‚
â”‚     (Background)                                                        â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Get Subscriptions                         â”‚
â”‚          â”‚                    SELECT * FROM push_subscriptions          â”‚
â”‚          â”‚                    WHERE user_id = ...                       â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Send to FCM/APNS                          â”‚
â”‚          â”‚                    FOR EACH subscription                     â”‚
â”‚          â”‚                      send_push(endpoint, payload)            â”‚
â”‚          â”‚                                                              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Update Status                             â”‚
â”‚                                UPDATE push_notification_queue           â”‚
â”‚                                SET status = 'sent'                      â”‚
â”‚                                                                         â”‚
â”‚  2. User Receives                                                       â”‚
â”‚     â”œâ”€ Mobile: Native push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ CUSTOMER            â”‚
â”‚     â”œâ”€ Web: Service worker push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ CUSTOMER            â”‚
â”‚     â””â”€ In-app: Realtime notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ CUSTOMER            â”‚
â”‚                                                                         â”‚
â”‚  3. Provider Receives                                                   â”‚
â”‚     â”œâ”€ Mobile: Native push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ PROVIDER            â”‚
â”‚     â”œâ”€ Sound: Alert tone                                                â”‚
â”‚     â””â”€ Vibration: Haptic feedback                                       â”‚
â”‚                                                                         â”‚
â”‚  NOTIFICATION TYPES:                                                    â”‚
â”‚  â€¢ Status updates (matched, in_progress, completed)                     â”‚
â”‚  â€¢ New job alerts (for providers)                                       â”‚
â”‚  â€¢ Rating reminders (1 hour after completion)                           â”‚
â”‚  â€¢ Promo alerts (new promos, expiring soon)                             â”‚
â”‚  â€¢ Payment confirmations                                                â”‚
â”‚  â€¢ System announcements                                                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Cross-Role Real-time Synchronization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              REAL-TIME SYNCHRONIZATION ACROSS ALL ROLES                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  CUSTOMER              SUPABASE REALTIME              PROVIDER          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                         â”‚
â”‚  1. Subscribe                                                           â”‚
â”‚     useRealtime()                                                       â”‚
â”‚     .subscribe(                                                         â”‚
â”‚       'ride:123'                                                        â”‚
â”‚     )                                                                   â”‚
â”‚          â”‚                                                              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ WebSocket Connection                      â”‚
â”‚          â”‚                    wss://supabase.co                         â”‚
â”‚          â”‚                    /realtime/v1                              â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     Connected â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Channel: ride:123 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Subscribe â”‚
â”‚                                                                         â”‚
â”‚  2. Status Update                                                       â”‚
â”‚                                                        Provider updates â”‚
â”‚                                                        status           â”‚
â”‚                                                             â”‚           â”‚
â”‚                                                             â–¼           â”‚
â”‚                              UPDATE ride_requests â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                              SET status = 'matched'                     â”‚
â”‚                                      â”‚                                  â”‚
â”‚                                      â–¼                                  â”‚
â”‚                              Realtime Broadcast                         â”‚
â”‚                              â”œâ”€ Event: UPDATE                           â”‚
â”‚                              â”œâ”€ Table: ride_requests                    â”‚
â”‚                              â”œâ”€ Filter: id=123                          â”‚
â”‚                              â””â”€ Payload: { status: 'matched', ... }     â”‚
â”‚                                      â”‚                                  â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚          â”‚                                                       â”‚     â”‚
â”‚          â–¼                                                       â–¼     â”‚
â”‚     Receive Update                                         Receive     â”‚
â”‚     â”œâ”€ Update UI                                           Confirmationâ”‚
â”‚     â”œâ”€ Show notification                                   â”œâ”€ Update UIâ”‚
â”‚     â””â”€ Play sound                                          â””â”€ Haptic   â”‚
â”‚                                                                         â”‚
â”‚  3. Location Updates                                                    â”‚
â”‚                                                        Provider sends   â”‚
â”‚                                                        GPS every 5s     â”‚
â”‚                                                             â”‚           â”‚
â”‚                                                             â–¼           â”‚
â”‚                              UPDATE service_providers â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                              SET current_lat = 13.7563,                 â”‚
â”‚                                  current_lng = 100.5018                 â”‚
â”‚                                      â”‚                                  â”‚
â”‚                                      â–¼                                  â”‚
â”‚                              Realtime Broadcast                         â”‚
â”‚                                      â”‚                                  â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚     Update Map                                                          â”‚
â”‚     â”œâ”€ Move marker                                                      â”‚
â”‚     â”œâ”€ Update ETA                                                       â”‚
â”‚     â””â”€ Smooth animation                                                 â”‚
â”‚                                                                         â”‚
â”‚  ADMIN (Monitoring)                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚     Admin Dashboard                                                     â”‚
â”‚     â”œâ”€ Subscribe to ALL rides                                           â”‚
â”‚     â”œâ”€ See real-time updates                                            â”‚
â”‚     â”œâ”€ Monitor provider locations                                       â”‚
â”‚     â””â”€ View live statistics                                             â”‚
â”‚                                                                         â”‚
â”‚  LATENCY:                                                               â”‚
â”‚  â€¢ Status updates: < 100ms                                              â”‚
â”‚  â€¢ Location updates: < 200ms                                            â”‚
â”‚  â€¢ Notification delivery: < 500ms                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Diagrams Generated**: December 24, 2025  
**All flows verified and tested in production environment**
