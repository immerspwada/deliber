-- Enhanced Admin Providers V2 System (Fixed)\n-- Migration: 258_enhanced_admin_providers_v2_system_fixed.sql\n-- Description: Complete admin providers management system for providers_v2 table\n-- Date: 2026-01-13\n\n-- Create enhanced provider record type for admin views\nDROP TYPE IF EXISTS enhanced_provider_v2_record CASCADE;\n\nCREATE TYPE enhanced_provider_v2_record AS (\n  id UUID,\n  user_id UUID,\n  provider_uid TEXT,\n  first_name TEXT,\n  last_name TEXT,\n  full_name TEXT,\n  email TEXT,\n  phone_number TEXT,\n  status TEXT,\n  service_types TEXT[],\n  is_online BOOLEAN,\n  is_available BOOLEAN,\n  current_lat NUMERIC,\n  current_lng NUMERIC,\n  rating NUMERIC,\n  total_trips INTEGER,\n  total_earnings NUMERIC,\n  vehicle_type TEXT,\n  vehicle_plate TEXT,\n  vehicle_color TEXT,\n  vehicle_info JSONB,\n  license_number TEXT,\n  license_expiry DATE,\n  national_id TEXT,\n  documents JSONB,\n  provider_type TEXT,\n  created_at TIMESTAMPTZ,\n  updated_at TIMESTAMPTZ,\n  approved_at TIMESTAMPTZ,\n  suspended_at TIMESTAMPTZ,\n  suspension_reason TEXT,\n  last_active_at TIMESTAMPTZ,\n  earnings_this_month NUMERIC,\n  trips_this_month INTEGER,\n  acceptance_rate NUMERIC,\n  completion_rate NUMERIC,\n  avg_response_time INTEGER\n);\n\n-- Enhanced get all providers function for admin (V2)\nCREATE OR REPLACE FUNCTION get_all_providers_v2_for_admin(\n  p_status TEXT DEFAULT NULL,\n  p_service_type TEXT DEFAULT NULL,\n  p_is_online BOOLEAN DEFAULT NULL,\n  p_limit INTEGER DEFAULT 20,\n  p_offset INTEGER DEFAULT 0,\n  p_search TEXT DEFAULT NULL,\n  p_sort_by TEXT DEFAULT 'created_at',\n  p_sort_order TEXT DEFAULT 'desc'\n)\nRETURNS SETOF enhanced_provider_v2_record\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  query_text TEXT;\n  sort_clause TEXT;\nBEGIN\n  -- Build sort clause\n  sort_clause := CASE p_sort_by\n    WHEN 'name' THEN 'full_name'\n    WHEN 'email' THEN 'email'\n    WHEN 'rating' THEN 'rating'\n    WHEN 'total_trips' THEN 'total_trips'\n    WHEN 'total_earnings' THEN 'total_earnings'\n    WHEN 'status' THEN 'status'\n    WHEN 'approved_at' THEN 'approved_at'\n    ELSE 'created_at'\n  END;\n  \n  IF p_sort_order = 'asc' THEN\n    sort_clause := sort_clause || ' ASC NULLS LAST';\n  ELSE\n    sort_clause := sort_clause || ' DESC NULLS LAST';\n  END IF;\n\n  -- Main query with enhanced provider data\n  RETURN QUERY EXECUTE format('\n    WITH provider_stats AS (\n      SELECT \n        p.id,\n        COUNT(CASE WHEN j.created_at >= date_trunc(''month'', NOW()) THEN 1 END) as trips_this_month,\n        COALESCE(SUM(CASE WHEN j.created_at >= date_trunc(''month'', NOW()) THEN j.final_earnings END), 0) as earnings_this_month,\n        COALESCE(AVG(CASE WHEN pm.metric_date >= date_trunc(''month'', NOW())::date THEN pm.acceptance_rate END), 0) as acceptance_rate,\n        COALESCE(AVG(CASE WHEN pm.metric_date >= date_trunc(''month'', NOW())::date THEN pm.completion_rate END), 0) as completion_rate,\n        COALESCE(AVG(CASE WHEN pm.metric_date >= date_trunc(''month'', NOW())::date THEN pm.avg_response_time_seconds END), 0) as avg_response_time\n      FROM providers_v2 p\n      LEFT JOIN jobs_v2 j ON p.id = j.provider_id AND j.status = ''completed''\n      LEFT JOIN provider_performance_metrics pm ON p.id = pm.provider_id\n      GROUP BY p.id\n    ),\n    last_activity AS (\n      SELECT \n        provider_id,\n        MAX(recorded_at) as last_active_at\n      FROM provider_location_history\n      GROUP BY provider_id\n    )\n    SELECT \n      p.id,\n      p.user_id,\n      p.provider_uid,\n      p.first_name,\n      p.last_name,\n      (p.first_name || '' '' || p.last_name)::TEXT as full_name,\n      p.email,\n      p.phone_number,\n      p.status::TEXT,\n      p.service_types::TEXT[],\n      p.is_online,\n      p.is_available,\n      p.current_lat,\n      p.current_lng,\n      p.rating,\n      p.total_trips,\n      p.total_earnings,\n      p.vehicle_type,\n      p.vehicle_plate,\n      p.vehicle_color,\n      p.vehicle_info,\n      p.license_number,\n      p.license_expiry,\n      p.national_id,\n      p.documents,\n      p.provider_type,\n      p.created_at,\n      p.updated_at,\n      p.approved_at,\n      p.suspended_at,\n      p.suspension_reason,\n      la.last_active_at,\n      COALESCE(ps.earnings_this_month, 0)::NUMERIC as earnings_this_month,\n      COALESCE(ps.trips_this_month, 0)::INTEGER as trips_this_month,\n      COALESCE(ps.acceptance_rate, 0)::NUMERIC as acceptance_rate,\n      COALESCE(ps.completion_rate, 0)::NUMERIC as completion_rate,\n      COALESCE(ps.avg_response_time, 0)::INTEGER as avg_response_time\n    FROM providers_v2 p\n    LEFT JOIN provider_stats ps ON p.id = ps.id\n    LEFT JOIN last_activity la ON p.id = la.provider_id\n    WHERE ($1 IS NULL OR p.status::TEXT = $1)\n      AND ($2 IS NULL OR $2 = ANY(p.service_types::TEXT[]))\n      AND ($3 IS NULL OR p.is_online = $3)\n      AND ($6 IS NULL OR (\n        p.first_name ILIKE ''%%'' || $6 || ''%%'' OR\n        p.last_name ILIKE ''%%'' || $6 || ''%%'' OR\n        p.email ILIKE ''%%'' || $6 || ''%%'' OR\n        p.phone_number ILIKE ''%%'' || $6 || ''%%'' OR\n        p.provider_uid ILIKE ''%%'' || $6 || ''%%''\n      ))\n    ORDER BY %s\n    LIMIT $4 OFFSET $5\n  ', sort_clause)\n  USING p_status, p_service_type, p_is_online, p_limit, p_offset, p_search;\nEND;\n$$;\n\n-- Count function for pagination (V2)\nCREATE OR REPLACE FUNCTION count_all_providers_v2_for_admin(\n  p_status TEXT DEFAULT NULL,\n  p_service_type TEXT DEFAULT NULL,\n  p_is_online BOOLEAN DEFAULT NULL,\n  p_search TEXT DEFAULT NULL\n)\nRETURNS INTEGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  total_count INTEGER;\nBEGIN\n  SELECT COUNT(*) INTO total_count\n  FROM providers_v2 p\n  WHERE (p_status IS NULL OR p.status::TEXT = p_status)\n    AND (p_service_type IS NULL OR p_service_type = ANY(p.service_types::TEXT[]))\n    AND (p_is_online IS NULL OR p.is_online = p_is_online)\n    AND (p_search IS NULL OR (\n      p.first_name ILIKE '%' || p_search || '%' OR\n      p.last_name ILIKE '%' || p_search || '%' OR\n      p.email ILIKE '%' || p_search || '%' OR\n      p.phone_number ILIKE '%' || p_search || '%' OR\n      p.provider_uid ILIKE '%' || p_search || '%'\n    ));\n\n  RETURN total_count;\nEND;\n$$;\n\n-- Enhanced provider analytics function (V2)\nCREATE OR REPLACE FUNCTION get_providers_v2_analytics_for_admin()\nRETURNS JSON\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  result JSON;\nBEGIN\n  WITH provider_stats AS (\n    SELECT \n      COUNT(*) as total_providers,\n      COUNT(CASE WHEN status = 'active' THEN 1 END) as active_providers,\n      COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_providers,\n      COUNT(CASE WHEN status = 'approved' THEN 1 END) as approved_providers,\n      COUNT(CASE WHEN status = 'suspended' THEN 1 END) as suspended_providers,\n      COUNT(CASE WHEN is_online = true THEN 1 END) as online_providers,\n      COUNT(CASE WHEN created_at >= date_trunc('month', NOW()) THEN 1 END) as new_this_month,\n      COUNT(CASE WHEN approved_at >= date_trunc('month', NOW()) THEN 1 END) as approved_this_month,\n      ROUND(AVG(rating), 2) as avg_rating,\n      SUM(total_trips) as total_trips_all,\n      SUM(total_earnings) as total_earnings_all\n    FROM providers_v2\n  ),\n  service_breakdown AS (\n    SELECT \n      unnest(service_types)::TEXT as service_type,\n      COUNT(*) as provider_count\n    FROM providers_v2\n    WHERE status IN ('active', 'approved')\n    GROUP BY unnest(service_types)\n  ),\n  monthly_performance AS (\n    SELECT \n      DATE_TRUNC('month', created_at) as month,\n      COUNT(*) as registrations,\n      COUNT(CASE WHEN approved_at IS NOT NULL THEN 1 END) as approvals\n    FROM providers_v2\n    WHERE created_at >= NOW() - INTERVAL '6 months'\n    GROUP BY DATE_TRUNC('month', created_at)\n    ORDER BY month\n  )\n  SELECT json_build_object(\n    'overview', json_build_object(\n      'total_providers', ps.total_providers,\n      'active_providers', ps.active_providers,\n      'pending_providers', ps.pending_providers,\n      'approved_providers', ps.approved_providers,\n      'suspended_providers', ps.suspended_providers,\n      'online_providers', ps.online_providers,\n      'new_this_month', ps.new_this_month,\n      'approved_this_month', ps.approved_this_month,\n      'avg_rating', ps.avg_rating,\n      'total_trips_all', ps.total_trips_all,\n      'total_earnings_all', ps.total_earnings_all\n    ),\n    'service_breakdown', (\n      SELECT json_agg(json_build_object(\n        'service_type', service_type,\n        'provider_count', provider_count\n      ))\n      FROM service_breakdown\n    ),\n    'monthly_performance', (\n      SELECT json_agg(json_build_object(\n        'month', month,\n        'registrations', registrations,\n        'approvals', approvals\n      ))\n      FROM monthly_performance\n    )\n  ) INTO result\n  FROM provider_stats ps;\n\n  RETURN result;\nEND;\n$$;\n\n-- Enhanced provider approval function (V2)\nCREATE OR REPLACE FUNCTION approve_provider_v2_enhanced(\n  p_provider_id UUID,\n  p_admin_id UUID DEFAULT NULL,\n  p_service_types TEXT[] DEFAULT NULL,\n  p_notes TEXT DEFAULT NULL\n)\nRETURNS JSON\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  provider_record providers_v2%ROWTYPE;\n  result JSON;\nBEGIN\n  -- Get provider details\n  SELECT * INTO provider_record FROM providers_v2 WHERE id = p_provider_id;\n  \n  IF NOT FOUND THEN\n    RETURN json_build_object('success', false, 'error', 'Provider not found');\n  END IF;\n\n  -- Update provider status\n  UPDATE providers_v2 \n  SET \n    status = 'approved'::provider_status,\n    service_types = COALESCE(p_service_types::service_type[], service_types),\n    approved_at = NOW(),\n    updated_at = NOW()\n  WHERE id = p_provider_id;\n\n  -- Log the approval\n  INSERT INTO status_audit_log (\n    entity_type, entity_id, old_status, new_status, \n    changed_by, changed_by_role, reason, metadata\n  ) VALUES (\n    'provider', p_provider_id, provider_record.status::TEXT, 'approved',\n    p_admin_id, 'admin', p_notes, \n    json_build_object('service_types', p_service_types)\n  );\n\n  -- Create notification for provider\n  INSERT INTO user_notifications (\n    user_id, type, title, message, data\n  ) VALUES (\n    provider_record.user_id, 'provider_approved',\n    'Provider Application Approved',\n    'Congratulations! Your provider application has been approved.',\n    json_build_object('provider_id', p_provider_id, 'service_types', p_service_types)\n  );\n\n  SELECT json_build_object(\n    'success', true,\n    'provider_id', p_provider_id,\n    'status', 'approved',\n    'service_types', p_service_types\n  ) INTO result;\n\n  RETURN result;\nEND;\n$$;\n\n-- Enhanced provider rejection function (V2)\nCREATE OR REPLACE FUNCTION reject_provider_v2_enhanced(\n  p_provider_id UUID,\n  p_admin_id UUID DEFAULT NULL,\n  p_reason TEXT DEFAULT NULL\n)\nRETURNS JSON\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  provider_record providers_v2%ROWTYPE;\n  result JSON;\nBEGIN\n  -- Get provider details\n  SELECT * INTO provider_record FROM providers_v2 WHERE id = p_provider_id;\n  \n  IF NOT FOUND THEN\n    RETURN json_build_object('success', false, 'error', 'Provider not found');\n  END IF;\n\n  -- Update provider status\n  UPDATE providers_v2 \n  SET \n    status = 'rejected'::provider_status,\n    updated_at = NOW()\n  WHERE id = p_provider_id;\n\n  -- Log the rejection\n  INSERT INTO status_audit_log (\n    entity_type, entity_id, old_status, new_status, \n    changed_by, changed_by_role, reason\n  ) VALUES (\n    'provider', p_provider_id, provider_record.status::TEXT, 'rejected',\n    p_admin_id, 'admin', p_reason\n  );\n\n  -- Create notification for provider\n  INSERT INTO user_notifications (\n    user_id, type, title, message, data\n  ) VALUES (\n    provider_record.user_id, 'provider_rejected',\n    'Provider Application Rejected',\n    'Your provider application has been rejected. Reason: ' || COALESCE(p_reason, 'No reason provided'),\n    json_build_object('provider_id', p_provider_id, 'reason', p_reason)\n  );\n\n  SELECT json_build_object(\n    'success', true,\n    'provider_id', p_provider_id,\n    'status', 'rejected',\n    'reason', p_reason\n  ) INTO result;\n\n  RETURN result;\nEND;\n$$;\n\n-- Enhanced provider suspension function (V2)\nCREATE OR REPLACE FUNCTION suspend_provider_v2_enhanced(\n  p_provider_id UUID,\n  p_admin_id UUID DEFAULT NULL,\n  p_reason TEXT DEFAULT NULL\n)\nRETURNS JSON\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  provider_record providers_v2%ROWTYPE;\n  result JSON;\nBEGIN\n  -- Get provider details\n  SELECT * INTO provider_record FROM providers_v2 WHERE id = p_provider_id;\n  \n  IF NOT FOUND THEN\n    RETURN json_build_object('success', false, 'error', 'Provider not found');\n  END IF;\n\n  -- Update provider status\n  UPDATE providers_v2 \n  SET \n    status = 'suspended'::provider_status,\n    suspended_at = NOW(),\n    suspension_reason = p_reason,\n    is_online = false,\n    is_available = false,\n    updated_at = NOW()\n  WHERE id = p_provider_id;\n\n  -- Log the suspension\n  INSERT INTO status_audit_log (\n    entity_type, entity_id, old_status, new_status, \n    changed_by, changed_by_role, reason\n  ) VALUES (\n    'provider', p_provider_id, provider_record.status::TEXT, 'suspended',\n    p_admin_id, 'admin', p_reason\n  );\n\n  -- Create notification for provider\n  INSERT INTO user_notifications (\n    user_id, type, title, message, data\n  ) VALUES (\n    provider_record.user_id, 'provider_suspended',\n    'Provider Account Suspended',\n    'Your provider account has been suspended. Reason: ' || COALESCE(p_reason, 'No reason provided'),\n    json_build_object('provider_id', p_provider_id, 'reason', p_reason)\n  );\n\n  SELECT json_build_object(\n    'success', true,\n    'provider_id', p_provider_id,\n    'status', 'suspended',\n    'reason', p_reason\n  ) INTO result;\n\n  RETURN result;\nEND;\n$$;\n\n-- Grant permissions to all functions\nGRANT EXECUTE ON FUNCTION get_all_providers_v2_for_admin(TEXT, TEXT, BOOLEAN, INTEGER, INTEGER, TEXT, TEXT, TEXT) TO anon, authenticated, service_role;\nGRANT EXECUTE ON FUNCTION count_all_providers_v2_for_admin(TEXT, TEXT, BOOLEAN, TEXT) TO anon, authenticated, service_role;\nGRANT EXECUTE ON FUNCTION get_providers_v2_analytics_for_admin() TO anon, authenticated, service_role;\nGRANT EXECUTE ON FUNCTION approve_provider_v2_enhanced(UUID, UUID, TEXT[], TEXT) TO anon, authenticated, service_role;\nGRANT EXECUTE ON FUNCTION reject_provider_v2_enhanced(UUID, UUID, TEXT) TO anon, authenticated, service_role;\nGRANT EXECUTE ON FUNCTION suspend_provider_v2_enhanced(UUID, UUID, TEXT) TO anon, authenticated, service_role;\n\n-- Comments\nCOMMENT ON FUNCTION get_all_providers_v2_for_admin IS 'Enhanced admin providers list for providers_v2 table with comprehensive filtering, sorting, and statistics';\nCOMMENT ON FUNCTION count_all_providers_v2_for_admin IS 'Count function for admin providers pagination (V2)';\nCOMMENT ON FUNCTION get_providers_v2_analytics_for_admin IS 'Get comprehensive provider analytics for admin dashboard (V2)';\nCOMMENT ON FUNCTION approve_provider_v2_enhanced IS 'Enhanced provider approval with service type assignment and notifications (V2)';\nCOMMENT ON FUNCTION reject_provider_v2_enhanced IS 'Enhanced provider rejection with reason and notifications (V2)';\nCOMMENT ON FUNCTION suspend_provider_v2_enhanced IS 'Enhanced provider suspension with reason and notifications (V2)';"