<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Customer Ride Map - Debug</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #1a1a1a;
    }
    
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .status.info {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .status.success {
      background: #e8f5e9;
      color: #388e3c;
    }
    
    .status.error {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .map-wrapper {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }
    
    #map {
      width: 100%;
      height: 400px;
    }
    
    .controls {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: #00a86b;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #00875a;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button.secondary {
      background: #6c757d;
    }
    
    button.secondary:hover {
      background: #5a6268;
    }
    
    .log {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
    }
    
    .log h3 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #1a1a1a;
    }
    
    .log-entry {
      font-size: 12px;
      font-family: 'Courier New', monospace;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      background: #f8f9fa;
      color: #495057;
    }
    
    .log-entry.error {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .log-entry.success {
      background: #e8f5e9;
      color: #388e3c;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üó∫Ô∏è Test Customer Ride Map</h1>
    
    <div id="status" class="status info">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Leaflet...
    </div>
    
    <div class="map-wrapper">
      <div id="map"></div>
    </div>
    
    <div class="controls">
      <button onclick="testCurrentLocation()">üìç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
      <button onclick="testAddMarkers()">üìå ‡πÄ‡∏û‡∏¥‡πà‡∏° Markers</button>
      <button onclick="testRoute()">üõ£Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
      <button onclick="testMapClick()">üëÜ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
      <button class="secondary" onclick="clearMap()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
    </div>
    
    <div class="log">
      <h3>üìã Debug Log</h3>
      <div id="log-container"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = null;
    let markers = [];
    let routeLine = null;
    let clickEnabled = false;
    
    function log(message, type = 'info') {
      const container = document.getElementById('log-container');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString('th-TH')}] ${message}`;
      container.insertBefore(entry, container.firstChild);
      console.log(message);
    }
    
    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
    }
    
    // Initialize map
    function initMap() {
      try {
        log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 'info');
        
        // Default center (Bangkok)
        const center = [13.7563, 100.5018];
        
        map = L.map('map', {
          center: center,
          zoom: 14,
          zoomControl: true,
          attributionControl: true
        });
        
        log('‡πÄ‡∏û‡∏¥‡πà‡∏° Tile Layer...', 'info');
        
        // CartoDB Positron (Light) - Same as production
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: 'abcd',
          maxZoom: 20
        }).addTo(map);
        
        log('‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!', 'success');
        updateStatus('‚úÖ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        
        // Add click handler
        map.on('click', function(e) {
          if (clickEnabled) {
            log(`‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`, 'success');
            addMarker(e.latlng.lat, e.latlng.lng, '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà');
          }
        });
        
      } catch (error) {
        log(`ERROR: ${error.message}`, 'error');
        updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 'error');
        console.error('Map init error:', error);
      }
    }
    
    function testCurrentLocation() {
      log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô...', 'info');
      updateStatus('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...', 'info');
      
      if (!navigator.geolocation) {
        log('ERROR: Geolocation ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', 'error');
        updateStatus('‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation', 'error');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          log(`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
          updateStatus('‚úÖ ‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success');
          
          map.setView([lat, lng], 16);
          addMarker(lat, lng, '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'pickup');
        },
        (error) => {
          log(`ERROR: ${error.message}`, 'error');
          updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ', 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
    
    function addMarker(lat, lng, title, type = 'default') {
      if (!map) {
        log('ERROR: ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°', 'error');
        return;
      }
      
      const marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup(title);
      markers.push(marker);
      
      log(`‡πÄ‡∏û‡∏¥‡πà‡∏° Marker: ${title} (${lat.toFixed(6)}, ${lng.toFixed(6)})`, 'success');
    }
    
    function testAddMarkers() {
      log('‡πÄ‡∏û‡∏¥‡πà‡∏° Test Markers...', 'info');
      
      // Pickup (Bangkok)
      addMarker(13.7563, 100.5018, 'üìç ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö', 'pickup');
      
      // Destination (nearby)
      addMarker(13.7463, 100.5318, 'üèÅ ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢', 'destination');
      
      // Fit bounds
      if (markers.length >= 2) {
        const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
        map.fitBounds(bounds, { padding: [50, 50] });
        log('‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô Markers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'success');
      }
      
      updateStatus('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Markers ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }
    
    async function testRoute() {
      if (markers.length < 2) {
        log('ERROR: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Markers ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏à‡∏∏‡∏î', 'error');
        updateStatus('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° Markers ‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }
      
      log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...', 'info');
      updateStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...', 'info');
      
      const start = markers[0].getLatLng();
      const end = markers[markers.length - 1].getLatLng();
      
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
        
        log(`OSRM URL: ${url}`, 'info');
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.code !== 'Ok' || !data.routes[0]) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á');
        }
        
        const route = data.routes[0];
        const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
        
        // Draw route
        if (routeLine) {
          map.removeLayer(routeLine);
        }
        
        routeLine = L.polyline(coordinates, {
          color: '#000000',
          weight: 4,
          opacity: 0.8
        }).addTo(map);
        
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
        
        const distance = (route.distance / 1000).toFixed(1);
        const duration = Math.ceil(route.duration / 60);
        
        log(`‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ${distance} ‡∏Å‡∏°., ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ`, 'success');
        updateStatus(`‚úÖ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ${distance} ‡∏Å‡∏°., ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ`, 'success');
        
      } catch (error) {
        log(`ERROR: ${error.message}`, 'error');
        updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ', 'error');
      }
    }
    
    function testMapClick() {
      clickEnabled = !clickEnabled;
      
      if (clickEnabled) {
        log('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 'success');
        updateStatus('üëÜ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Marker', 'info');
      } else {
        log('‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 'info');
        updateStatus('‚úÖ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
      }
    }
    
    function clearMap() {
      log('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 'info');
      
      // Remove markers
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      
      // Remove route
      if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
      }
      
      clickEnabled = false;
      
      log('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      updateStatus('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }
    
    // Initialize on load
    window.addEventListener('load', () => {
      log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
      setTimeout(initMap, 100);
    });
  </script>
</body>
</html>
