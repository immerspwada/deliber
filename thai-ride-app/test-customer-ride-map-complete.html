<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Customer Ride Map - Complete</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .header {
      padding: 20px;
      background: linear-gradient(135deg, #00a86b 0%, #00875a 100%);
      color: white;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .map-section {
      padding: 16px;
      background: #fff;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .map-wrapper {
      position: relative;
      width: 100%;
      height: 240px;
      border-radius: 16px;
      overflow: hidden;
      background-color: #f5f5f5;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    .map-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 12px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%);
      border-radius: 24px;
      font-size: 13px;
      color: #495057;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      animation: hint-pulse 2s ease-in-out infinite;
    }
    
    .map-hint svg {
      color: #00a86b;
      animation: pin-bounce 1.5s ease-in-out infinite;
    }
    
    @keyframes hint-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    
    @keyframes pin-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    
    .route-info {
      position: absolute;
      bottom: 12px;
      left: 12px;
      display: flex;
      gap: 16px;
      background-color: white;
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }
    
    .route-stat {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .route-icon {
      width: 16px;
      height: 16px;
      color: #666;
    }
    
    .info-section {
      padding: 20px;
    }
    
    .info-item {
      margin-bottom: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      background: #00a86b;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }
    
    .btn:hover {
      background: #00875a;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    /* Custom marker styles */
    .pickup-marker svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .destination-marker svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .pulse-ring {
      transform-origin: center;
    }
    
    .pulse-ring-1 {
      animation: pulse-outer 2s ease-out infinite;
    }
    
    .pulse-ring-2 {
      animation: pulse-inner 2s ease-out infinite 0.3s;
    }
    
    @keyframes pulse-outer {
      0% { transform: scale(0.8); opacity: 0.6; }
      100% { transform: scale(1.4); opacity: 0; }
    }
    
    @keyframes pulse-inner {
      0% { transform: scale(0.8); opacity: 0.8; }
      100% { transform: scale(1.3); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üó∫Ô∏è Customer Ride Map</h1>
      <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</p>
    </div>
    
    <div class="map-section">
      <div class="map-wrapper">
        <div id="map"></div>
        <div id="routeInfo" class="route-info" style="display: none;">
          <div class="route-stat">
            <svg class="route-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
            </svg>
            <span id="distance">-</span>
          </div>
          <div class="route-stat">
            <svg class="route-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span id="duration">-</span>
          </div>
        </div>
      </div>
      
      <div id="mapHint" class="map-hint">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" />
          <circle cx="12" cy="10" r="3" />
        </svg>
        <span>‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</span>
      </div>
    </div>
    
    <div class="info-section">
      <div class="info-item">
        <div class="info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
        <div class="info-value">
          <span id="mapStatus" class="status warning">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö (Pickup)</div>
        <div class="info-value" id="pickupInfo">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (Destination)</div>
        <div class="info-value" id="destinationInfo">-</div>
      </div>
      
      <button class="btn" onclick="testRandomDestination()">
        üé≤ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
      </button>
      
      <button class="btn" onclick="clearMap()">
        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
      </button>
    </div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  
  <script>
    let map = null;
    let pickupMarker = null;
    let destinationMarker = null;
    let routeLine = null;
    
    // Bangkok center
    const DEFAULT_CENTER = { lat: 13.7563, lng: 100.5018 };
    
    // Custom pickup icon
    const pickupIcon = L.divIcon({
      html: `
        <div class="pickup-marker">
          <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <circle cx="24" cy="24" r="20" fill="none" stroke="#22C55E" stroke-width="2" opacity="0.3" class="pulse-ring pulse-ring-1"/>
            <circle cx="24" cy="24" r="14" fill="none" stroke="#22C55E" stroke-width="2" opacity="0.5" class="pulse-ring pulse-ring-2"/>
            <circle cx="24" cy="24" r="10" fill="#22C55E"/>
            <circle cx="24" cy="24" r="6" fill="#fff"/>
            <circle cx="24" cy="24" r="3" fill="#22C55E"/>
          </svg>
        </div>
      `,
      className: 'custom-marker pickup-icon',
      iconSize: [48, 48],
      iconAnchor: [24, 24]
    });
    
    // Custom destination icon
    const destinationIcon = L.divIcon({
      html: `
        <div class="destination-marker">
          <svg width="36" height="48" viewBox="0 0 36 48" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="18" cy="46" rx="6" ry="2" fill="#000" opacity="0.2"/>
            <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#FF3B30"/>
            <circle cx="18" cy="18" r="8" fill="#fff"/>
            <path d="M15 12v12M15 12l6 3-6 3" stroke="#EF4444" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      `,
      className: 'custom-marker destination-icon',
      iconSize: [36, 48],
      iconAnchor: [18, 48]
    });
    
    // Initialize map
    function initMap() {
      console.log('üó∫Ô∏è Initializing map...');
      
      map = L.map('map', {
        center: [DEFAULT_CENTER.lat, DEFAULT_CENTER.lng],
        zoom: 14,
        zoomControl: true
      });
      
      // Add tile layer
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(map);
      
      // Add pickup marker at center
      pickupMarker = L.marker([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], {
        icon: pickupIcon,
        title: '‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö'
      }).addTo(map);
      
      updateStatus('success', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ');
      updatePickupInfo(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng);
      
      // Map click handler
      map.on('click', handleMapClick);
      
      console.log('‚úÖ Map initialized successfully');
    }
    
    // Handle map click
    async function handleMapClick(e) {
      const { lat, lng } = e.latlng;
      console.log('üìç Map clicked:', lat, lng);
      
      // Haptic feedback
      if ('vibrate' in navigator) {
        navigator.vibrate(30);
      }
      
      // Add/update destination marker
      if (destinationMarker) {
        destinationMarker.setLatLng([lat, lng]);
      } else {
        destinationMarker = L.marker([lat, lng], {
          icon: destinationIcon,
          title: '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
        }).addTo(map);
      }
      
      // Hide hint
      document.getElementById('mapHint').style.display = 'none';
      
      // Update info
      updateDestinationInfo(lat, lng);
      
      // Calculate route
      await calculateRoute();
    }
    
    // Calculate route using OSRM
    async function calculateRoute() {
      if (!pickupMarker || !destinationMarker) return;
      
      const pickup = pickupMarker.getLatLng();
      const destination = destinationMarker.getLatLng();
      
      console.log('üõ£Ô∏è Calculating route...');
      
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${pickup.lng},${pickup.lat};${destination.lng},${destination.lat}?overview=full&geometries=geojson`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.code !== 'Ok' || !data.routes[0]) {
          console.error('‚ùå Route calculation failed');
          return;
        }
        
        const route = data.routes[0];
        const coordinates = route.geometry.coordinates.map(
          coord => [coord[1], coord[0]]
        );
        
        // Draw route
        if (routeLine) {
          routeLine.remove();
        }
        
        routeLine = L.polyline(coordinates, {
          color: '#000000',
          weight: 4,
          opacity: 0.8
        }).addTo(map);
        
        // Fit bounds
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
        
        // Update route info
        const distance = (route.distance / 1000).toFixed(1);
        const duration = Math.ceil(route.duration / 60);
        
        document.getElementById('distance').textContent = `${distance} ‡∏Å‡∏°.`;
        document.getElementById('duration').textContent = `${duration} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        document.getElementById('routeInfo').style.display = 'flex';
        
        console.log('‚úÖ Route calculated:', distance, 'km,', duration, 'min');
      } catch (error) {
        console.error('‚ùå Route calculation error:', error);
      }
    }
    
    // Test random destination
    function testRandomDestination() {
      const pickup = pickupMarker.getLatLng();
      
      // Random offset (¬±0.02 degrees ‚âà 2km)
      const lat = pickup.lat + (Math.random() - 0.5) * 0.04;
      const lng = pickup.lng + (Math.random() - 0.5) * 0.04;
      
      handleMapClick({ latlng: { lat, lng } });
    }
    
    // Clear map
    function clearMap() {
      if (destinationMarker) {
        destinationMarker.remove();
        destinationMarker = null;
      }
      
      if (routeLine) {
        routeLine.remove();
        routeLine = null;
      }
      
      document.getElementById('mapHint').style.display = 'flex';
      document.getElementById('routeInfo').style.display = 'none';
      document.getElementById('destinationInfo').textContent = '-';
      
      // Reset view
      map.setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], 14);
      
      console.log('üóëÔ∏è Map cleared');
    }
    
    // Update status
    function updateStatus(type, text) {
      const statusEl = document.getElementById('mapStatus');
      statusEl.className = `status ${type}`;
      statusEl.textContent = text;
    }
    
    // Update pickup info
    function updatePickupInfo(lat, lng) {
      document.getElementById('pickupInfo').textContent = 
        `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }
    
    // Update destination info
    function updateDestinationInfo(lat, lng) {
      document.getElementById('destinationInfo').textContent = 
        `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }
    
    // Initialize on load
    window.addEventListener('load', () => {
      console.log('üöÄ Starting map test...');
      initMap();
    });
  </script>
</body>
</html>
