<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Provider Job Visibility Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .header {
            background: linear-gradient(135deg, #00a86b 0%, #00c77b 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin: 8px 0;
        }
        .status.success { background: #dcfce7; color: #16a34a; }
        .status.error { background: #fee2e2; color: #dc2626; }
        .status.pending { background: #fef3c7; color: #d97706; }
        .test-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 8px 8px 0;
            font-weight: 600;
        }
        .test-btn:hover { background: #2563eb; }
        .test-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .result {
            background: #f1f5f9;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .job-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            background: #fafafa;
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .job-id { font-weight: 600; color: #1e293b; }
        .job-fare { font-size: 18px; font-weight: 700; color: #059669; }
        .route { font-size: 14px; color: #475569; margin: 4px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Provider Job Visibility Fix Test</h1>
        <p>Testing simplified RLS policies for provider job visibility</p>
    </div>

    <div class="test-section">
        <h2>üìã Test Summary</h2>
        <p><strong>Issue:</strong> Providers at <code>/provider</code> cannot see jobs created by customers at <code>/customer/ride</code></p>
        <p><strong>Solution:</strong> Simplified RLS policies removing complex distance/location filters</p>
        <p><strong>Status:</strong> <span id="overall-status" class="status pending">Testing...</span></p>
    </div>

    <div class="test-section">
        <h2>üóÑÔ∏è Database Tests</h2>
        
        <h3>1. Check Pending Rides</h3>
        <button class="test-btn" onclick="testPendingRides()">Test Pending Rides</button>
        <div id="pending-rides-result" class="result" style="display: none;"></div>

        <h3>2. Test RLS Policies</h3>
        <button class="test-btn" onclick="testRLSPolicies()">Test RLS Policies</button>
        <div id="rls-result" class="result" style="display: none;"></div>

        <h3>3. Test Simple Function</h3>
        <button class="test-btn" onclick="testSimpleFunction()">Test get_all_pending_rides()</button>
        <div id="function-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üåê Frontend Tests</h2>
        
        <h3>Customer Side</h3>
        <button class="test-btn" onclick="openCustomerRide()">Open Customer Ride Page</button>
        <p>Create a new ride request to test the flow</p>

        <h3>Provider Side</h3>
        <button class="test-btn" onclick="openProviderDashboard()">Open Provider Dashboard</button>
        <p>Check if the SimpleProviderDashboard shows available jobs</p>
    </div>

    <div class="test-section">
        <h2>üìä Available Jobs</h2>
        <div id="jobs-list">
            <p>Click "Load Available Jobs" to see current pending rides</p>
        </div>
        <button class="test-btn" onclick="loadAvailableJobs()">Load Available Jobs</button>
    </div>

    <div class="test-section">
        <h2>‚úÖ Expected Results</h2>
        <ul>
            <li>‚úÖ Database shows pending rides without provider_id</li>
            <li>‚úÖ RLS policies allow providers to see pending rides</li>
            <li>‚úÖ Simple function returns available jobs</li>
            <li>‚úÖ Provider dashboard displays jobs from customer requests</li>
            <li>‚úÖ Job acceptance workflow works end-to-end</li>
        </ul>
    </div>

    <script>
        // Mock Supabase client for testing
        const SUPABASE_URL = 'https://onsflqhkgqhydeupiqyt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uc2ZscWhrZ3FoeWRldXBpcXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI5NjU0NTEsImV4cCI6MjA0ODU0MTQ1MX0.Ej5zOGJmYXJhZGlzZSIsInJlZiI6Im9uc2ZscWhrZ3FoeWRldXBpcXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI5NjU0NTEsImV4cCI6MjA0ODU0MTQ1MX0';

        async function testPendingRides() {
            const resultDiv = document.getElementById('pending-rides-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing pending rides...';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ride_requests?status=eq.pending&provider_id=is.null&select=id,tracking_id,pickup_address,destination_address,estimated_fare,created_at`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `‚úÖ SUCCESS: Found ${data.length} pending rides\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.textContent = `‚ùå ERROR: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå EXCEPTION: ${error.message}`;
            }
        }

        async function testRLSPolicies() {
            const resultDiv = document.getElementById('rls-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing RLS policies...';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_all_pending_rides`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `‚úÖ SUCCESS: RLS function returned ${data.length} rides\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.textContent = `‚ùå ERROR: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå EXCEPTION: ${error.message}`;
            }
        }

        async function testSimpleFunction() {
            const resultDiv = document.getElementById('function-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing simple function...';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_all_pending_rides`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    resultDiv.textContent = `‚úÖ SUCCESS: Function works correctly\nReturned ${data.length} pending rides\n\n${JSON.stringify(data, null, 2)}`;
                    updateOverallStatus('success');
                } else {
                    resultDiv.textContent = `‚ùå ERROR: ${JSON.stringify(data, null, 2)}`;
                    updateOverallStatus('error');
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå EXCEPTION: ${error.message}`;
                updateOverallStatus('error');
            }
        }

        async function loadAvailableJobs() {
            const jobsList = document.getElementById('jobs-list');
            jobsList.innerHTML = '<p>Loading available jobs...</p>';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_all_pending_rides`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const jobs = await response.json();
                
                if (response.ok && Array.isArray(jobs)) {
                    if (jobs.length === 0) {
                        jobsList.innerHTML = '<p>üì≠ No pending jobs available</p>';
                    } else {
                        jobsList.innerHTML = jobs.map(job => `
                            <div class="job-card">
                                <div class="job-header">
                                    <div class="job-id">${job.tracking_id || job.id}</div>
                                    <div class="job-fare">‡∏ø${job.estimated_fare}</div>
                                </div>
                                <div class="route">üìç ${job.pickup_address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                                <div class="route">üéØ ${job.destination_address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                                <div class="route">‚è∞ ${new Date(job.created_at).toLocaleString('th-TH')}</div>
                            </div>
                        `).join('');
                    }
                } else {
                    jobsList.innerHTML = `<p>‚ùå Error loading jobs: ${JSON.stringify(jobs)}</p>`;
                }
            } catch (error) {
                jobsList.innerHTML = `<p>‚ùå Exception: ${error.message}</p>`;
            }
        }

        function openCustomerRide() {
            window.open('http://localhost:5173/customer/ride', '_blank');
        }

        function openProviderDashboard() {
            window.open('http://localhost:5173/provider', '_blank');
        }

        function updateOverallStatus(status) {
            const statusEl = document.getElementById('overall-status');
            statusEl.className = `status ${status}`;
            
            switch(status) {
                case 'success':
                    statusEl.textContent = '‚úÖ Tests Passing';
                    break;
                case 'error':
                    statusEl.textContent = '‚ùå Tests Failing';
                    break;
                default:
                    statusEl.textContent = '‚è≥ Testing...';
            }
        }

        // Auto-load jobs on page load
        window.addEventListener('load', () => {
            setTimeout(loadAvailableJobs, 1000);
        });
    </script>
</body>
</html>