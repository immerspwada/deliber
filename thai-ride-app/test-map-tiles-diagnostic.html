<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Tiles Diagnostic Test</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { margin-bottom: 20px; color: #333; }
    .test-section { 
      background: white; 
      border-radius: 12px; 
      padding: 20px; 
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .map-container { 
      height: 400px; 
      border-radius: 8px; 
      overflow: hidden;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
    }
    .log { 
      background: #1e1e1e; 
      color: #d4d4d4; 
      padding: 15px; 
      border-radius: 8px; 
      font-family: 'Courier New', monospace; 
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-entry { margin-bottom: 5px; }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-warning { color: #fbbf24; }
    .log-info { color: #60a5fa; }
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 10px; 
      margin-top: 15px;
    }
    .stat-card {
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }
    .stat-label { font-size: 11px; color: #6b7280; text-transform: uppercase; }
    .stat-value { font-size: 24px; font-weight: bold; color: #1f2937; margin-top: 4px; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover { background: #2563eb; }
    button:active { transform: scale(0.98); }
    .provider-test {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .provider-card {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    .provider-card h3 { font-size: 14px; margin-bottom: 10px; color: #374151; }
    .provider-status { 
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }
    .status-loading { background: #fef3c7; color: #92400e; }
    .status-success { background: #d1fae5; color: #065f46; }
    .status-error { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üó∫Ô∏è Map Tiles Diagnostic Test</h1>
    
    <!-- Test 1: OpenStreetMap Standard -->
    <div class="test-section">
      <h2>Test 1: OpenStreetMap Standard</h2>
      <div id="map1" class="map-container"></div>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">Tiles Loading</div>
          <div class="stat-value" id="map1-loading">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Tiles Loaded</div>
          <div class="stat-value" id="map1-loaded">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Tiles Failed</div>
          <div class="stat-value" id="map1-failed">0</div>
        </div>
      </div>
      <div id="log1" class="log"></div>
    </div>

    <!-- Test 2: Multiple Tile Providers -->
    <div class="test-section">
      <h2>Test 2: Alternative Tile Providers</h2>
      <div class="provider-test" id="provider-tests"></div>
    </div>

    <!-- Test 3: Network Diagnostics -->
    <div class="test-section">
      <h2>Test 3: Network Diagnostics</h2>
      <button onclick="testTileUrls()">Test Tile URLs</button>
      <button onclick="testCORS()">Test CORS</button>
      <button onclick="testDNS()">Test DNS Resolution</button>
      <div id="network-log" class="log"></div>
    </div>

    <!-- Test 4: Browser Capabilities -->
    <div class="test-section">
      <h2>Test 4: Browser Capabilities</h2>
      <div id="browser-info" class="log"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Logging utilities
    function log(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Test 1: OpenStreetMap Standard
    function initMap1() {
      log('log1', 'Initializing OpenStreetMap test...', 'info');
      
      const map = L.map('map1', {
        center: [13.7563, 100.5018], // Bangkok
        zoom: 13,
        zoomControl: true
      });

      log('log1', 'Map instance created', 'success');

      let tilesLoading = 0;
      let tilesLoaded = 0;
      let tilesFailed = 0;

      const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        subdomains: ['a', 'b', 'c'],
        maxZoom: 19
      });

      tileLayer.on('loading', () => {
        log('log1', 'Tile layer started loading', 'info');
      });

      tileLayer.on('tileloadstart', (e) => {
        tilesLoading++;
        document.getElementById('map1-loading').textContent = tilesLoading;
        log('log1', `Tile load started: ${e.coords.z}/${e.coords.x}/${e.coords.y}`, 'info');
      });

      tileLayer.on('tileload', (e) => {
        tilesLoaded++;
        document.getElementById('map1-loaded').textContent = tilesLoaded;
        const img = e.tile;
        log('log1', `‚úì Tile loaded: ${e.coords.z}/${e.coords.x}/${e.coords.y} (${img.naturalWidth}x${img.naturalHeight})`, 'success');
      });

      tileLayer.on('tileerror', (e) => {
        tilesFailed++;
        document.getElementById('map1-failed').textContent = tilesFailed;
        const url = e.tile.src;
        log('log1', `‚úó Tile failed: ${url}`, 'error');
        
        // Try to fetch the tile manually to get more error details
        fetch(url)
          .then(res => {
            if (!res.ok) {
              log('log1', `HTTP ${res.status}: ${res.statusText}`, 'error');
            }
          })
          .catch(err => {
            log('log1', `Fetch error: ${err.message}`, 'error');
          });
      });

      tileLayer.on('load', () => {
        log('log1', `All tiles loaded! Success: ${tilesLoaded}, Failed: ${tilesFailed}`, 'success');
        
        // Check DOM
        setTimeout(() => {
          const container = map.getContainer();
          const tilePane = container.querySelector('.leaflet-tile-pane');
          const tiles = tilePane?.querySelectorAll('.leaflet-tile');
          
          log('log1', `DOM Check: ${tiles?.length || 0} tiles in DOM`, 'info');
          
          if (tiles && tiles.length > 0) {
            const firstTile = tiles[0];
            const styles = window.getComputedStyle(firstTile);
            log('log1', `First tile opacity: ${styles.opacity}, visibility: ${styles.visibility}`, 'info');
          }
        }, 500);
      });

      tileLayer.addTo(map);
      log('log1', 'Tile layer added to map', 'success');
    }

    // Test 2: Multiple Providers
    const providers = [
      {
        name: 'OpenStreetMap',
        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        subdomains: ['a', 'b', 'c']
      },
      {
        name: 'CartoDB Positron',
        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
        subdomains: ['a', 'b', 'c', 'd']
      },
      {
        name: 'CartoDB Dark',
        url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
        subdomains: ['a', 'b', 'c', 'd']
      },
      {
        name: 'OpenTopoMap',
        url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
        subdomains: ['a', 'b', 'c']
      }
    ];

    function testProvider(provider, index) {
      const card = document.createElement('div');
      card.className = 'provider-card';
      card.innerHTML = `
        <h3>${provider.name}</h3>
        <div id="provider-map-${index}" style="height: 200px; border-radius: 6px; overflow: hidden;"></div>
        <div class="provider-status status-loading" id="provider-status-${index}">Loading...</div>
      `;
      document.getElementById('provider-tests').appendChild(card);

      setTimeout(() => {
        try {
          const map = L.map(`provider-map-${index}`, {
            center: [13.7563, 100.5018],
            zoom: 13,
            zoomControl: false,
            attributionControl: false
          });

          const tileLayer = L.tileLayer(provider.url, {
            subdomains: provider.subdomains,
            maxZoom: 19
          });

          let loaded = false;
          let failed = false;

          tileLayer.on('load', () => {
            if (!failed) {
              loaded = true;
              const status = document.getElementById(`provider-status-${index}`);
              status.textContent = '‚úì Success';
              status.className = 'provider-status status-success';
            }
          });

          tileLayer.on('tileerror', () => {
            failed = true;
            const status = document.getElementById(`provider-status-${index}`);
            status.textContent = '‚úó Failed';
            status.className = 'provider-status status-error';
          });

          tileLayer.addTo(map);

          // Timeout check
          setTimeout(() => {
            if (!loaded && !failed) {
              const status = document.getElementById(`provider-status-${index}`);
              status.textContent = '‚è± Timeout';
              status.className = 'provider-status status-error';
            }
          }, 10000);
        } catch (err) {
          const status = document.getElementById(`provider-status-${index}`);
          status.textContent = `‚úó Error: ${err.message}`;
          status.className = 'provider-status status-error';
        }
      }, index * 500); // Stagger initialization
    }

    // Test 3: Network Diagnostics
    async function testTileUrls() {
      log('network-log', 'Testing tile URLs...', 'info');
      
      const testUrls = [
        'https://a.tile.openstreetmap.org/13/6450/3934.png',
        'https://b.tile.openstreetmap.org/13/6450/3934.png',
        'https://c.tile.openstreetmap.org/13/6450/3934.png'
      ];

      for (const url of testUrls) {
        try {
          const start = performance.now();
          const response = await fetch(url);
          const duration = (performance.now() - start).toFixed(0);
          
          if (response.ok) {
            const blob = await response.blob();
            log('network-log', `‚úì ${url} - ${response.status} (${duration}ms, ${blob.size} bytes)`, 'success');
          } else {
            log('network-log', `‚úó ${url} - ${response.status} ${response.statusText}`, 'error');
          }
        } catch (err) {
          log('network-log', `‚úó ${url} - ${err.message}`, 'error');
        }
      }
    }

    async function testCORS() {
      log('network-log', 'Testing CORS...', 'info');
      
      try {
        const response = await fetch('https://a.tile.openstreetmap.org/13/6450/3934.png', {
          mode: 'cors'
        });
        
        if (response.ok) {
          log('network-log', '‚úì CORS is working correctly', 'success');
          const headers = Array.from(response.headers.entries());
          headers.forEach(([key, value]) => {
            log('network-log', `  ${key}: ${value}`, 'info');
          });
        } else {
          log('network-log', `‚úó CORS failed: ${response.status}`, 'error');
        }
      } catch (err) {
        log('network-log', `‚úó CORS error: ${err.message}`, 'error');
      }
    }

    async function testDNS() {
      log('network-log', 'Testing DNS resolution...', 'info');
      
      const domains = [
        'a.tile.openstreetmap.org',
        'b.tile.openstreetmap.org',
        'c.tile.openstreetmap.org'
      ];

      for (const domain of domains) {
        try {
          const start = performance.now();
          const response = await fetch(`https://${domain}/`, { method: 'HEAD' });
          const duration = (performance.now() - start).toFixed(0);
          log('network-log', `‚úì ${domain} resolved (${duration}ms)`, 'success');
        } catch (err) {
          log('network-log', `‚úó ${domain} failed: ${err.message}`, 'error');
        }
      }
    }

    // Test 4: Browser Capabilities
    function checkBrowserCapabilities() {
      const info = document.getElementById('browser-info');
      
      const capabilities = {
        'User Agent': navigator.userAgent,
        'Platform': navigator.platform,
        'Language': navigator.language,
        'Online': navigator.onLine,
        'Cookies Enabled': navigator.cookieEnabled,
        'Canvas Support': !!document.createElement('canvas').getContext,
        'WebGL Support': !!document.createElement('canvas').getContext('webgl'),
        'Service Worker': 'serviceWorker' in navigator,
        'Cache API': 'caches' in window,
        'Fetch API': 'fetch' in window,
        'Screen Width': window.screen.width,
        'Screen Height': window.screen.height,
        'Device Pixel Ratio': window.devicePixelRatio,
        'Connection Type': navigator.connection?.effectiveType || 'unknown',
        'Connection Downlink': navigator.connection?.downlink ? `${navigator.connection.downlink} Mbps` : 'unknown'
      };

      Object.entries(capabilities).forEach(([key, value]) => {
        const entry = document.createElement('div');
        entry.className = 'log-entry log-info';
        entry.textContent = `${key}: ${value}`;
        info.appendChild(entry);
      });
    }

    // Initialize tests
    window.addEventListener('DOMContentLoaded', () => {
      initMap1();
      providers.forEach((provider, index) => testProvider(provider, index));
      checkBrowserCapabilities();
    });
  </script>
</body>
</html>
