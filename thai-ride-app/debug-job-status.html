<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Job Status</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    .result {
      background: #000;
      padding: 20px;
      border: 2px solid #00ff00;
      border-radius: 8px;
      margin: 20px 0;
      white-space: pre-wrap;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px;
      margin: 10px 5px;
    }
    button:hover {
      background: #00cc00;
    }
    .error {
      color: #ff0000;
    }
    .success {
      color: #00ff00;
    }
    .warning {
      color: #ffff00;
    }
  </style>
</head>
<body>
  <h1>üîç Debug Job Status</h1>
  <p>Job ID: <strong>7e011cf4-cc74-4eea-afc8-5dd4fb01c5a0</strong></p>
  
  <button onclick="checkJobStatus()">Check Job Status</button>
  <button onclick="checkProviderInfo()">Check Provider Info</button>
  <button onclick="checkStatusFlow()">Check Status Flow Logic</button>
  
  <div id="result" class="result">Waiting for action...</div>

  <script>
    const SUPABASE_URL = 'http://127.0.0.1:54321'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const jobId = '7e011cf4-cc74-4eea-afc8-5dd4fb01c5a0'
    
    const STATUS_FLOW = [
      {
        key: 'matched',
        label: '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        icon: '‚úÖ',
        action: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏£‡∏±‡∏ö',
        dbStatus: ['matched', 'accepted', 'confirmed']
      },
      {
        key: 'pickup',
        label: '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
        icon: 'üìç',
        action: '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
        dbStatus: ['pickup', 'arrived', 'arriving', 'at_pickup']
      },
      {
        key: 'in_progress',
        label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
        icon: 'üõ£Ô∏è',
        action: '‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
        dbStatus: ['in_progress', 'picked_up', 'ongoing', 'started']
      },
      {
        key: 'completed',
        label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
        icon: 'üéâ',
        action: '‡∏™‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        dbStatus: ['completed', 'finished', 'done']
      }
    ]
    
    const STATUS_ALIASES = {
      'accepted': 'matched',
      'confirmed': 'matched',
      'arrived': 'pickup',
      'arriving': 'pickup',
      'at_pickup': 'pickup',
      'picked_up': 'in_progress',
      'ongoing': 'in_progress',
      'started': 'in_progress',
      'finished': 'completed',
      'done': 'completed'
    }
    
    function log(message, type = 'success') {
      const result = document.getElementById('result')
      const timestamp = new Date().toLocaleTimeString()
      result.innerHTML += `\n[${timestamp}] <span class="${type}">${message}</span>`
      result.scrollTop = result.scrollHeight
    }
    
    function clear() {
      document.getElementById('result').innerHTML = ''
    }
    
    async function checkJobStatus() {
      clear()
      log('üîç Checking job status from database...', 'warning')
      
      try {
        const { data, error } = await supabase
          .from('ride_requests')
          .select('*')
          .eq('id', jobId)
          .single()
        
        if (error) {
          log(`‚ùå Error: ${error.message}`, 'error')
          return
        }
        
        if (!data) {
          log('‚ùå Job not found!', 'error')
          return
        }
        
        log('‚úÖ Job found!', 'success')
        log('\nüìä Job Data:', 'warning')
        log(JSON.stringify({
          id: data.id,
          status: data.status,
          provider_id: data.provider_id,
          user_id: data.user_id,
          created_at: data.created_at,
          updated_at: data.updated_at,
          accepted_at: data.accepted_at,
          arrived_at: data.arrived_at,
          started_at: data.started_at,
          completed_at: data.completed_at,
          cancelled_at: data.cancelled_at
        }, null, 2))
        
        // Check status flow
        log('\nüîÑ Status Flow Analysis:', 'warning')
        const currentStatus = data.status
        const normalized = STATUS_ALIASES[currentStatus] || currentStatus
        
        log(`Current Status: "${currentStatus}"`)
        log(`Normalized Status: "${normalized}"`)
        
        const currentIndex = STATUS_FLOW.findIndex(step => 
          step.dbStatus.includes(normalized) || step.key === normalized
        )
        
        log(`Current Index: ${currentIndex}`)
        
        if (currentIndex === -1) {
          log('‚ùå Status NOT found in STATUS_FLOW!', 'error')
          log('Available statuses:', 'warning')
          STATUS_FLOW.forEach((step, i) => {
            log(`  ${i}. ${step.key}: ${step.dbStatus.join(', ')}`)
          })
        } else {
          log(`‚úÖ Status found at index ${currentIndex}`, 'success')
          log(`Current Step: ${STATUS_FLOW[currentIndex].label}`)
          
          if (currentIndex < STATUS_FLOW.length - 1) {
            const nextStep = STATUS_FLOW[currentIndex + 1]
            log(`\n‚úÖ Next Step Available:`, 'success')
            log(`  Label: ${nextStep.label}`)
            log(`  Action Button: "${nextStep.action}"`)
            log(`  Next DB Status: ${nextStep.dbStatus[0]}`)
          } else {
            log('\n‚ö†Ô∏è This is the last step (completed)', 'warning')
          }
        }
        
        // Check if completed or cancelled
        if (data.status === 'completed') {
          log('\nüéâ Job is COMPLETED - No button should show', 'warning')
        } else if (data.status === 'cancelled') {
          log('\n‚ùå Job is CANCELLED - No button should show', 'warning')
        }
        
      } catch (err) {
        log(`‚ùå Exception: ${err.message}`, 'error')
      }
    }
    
    async function checkProviderInfo() {
      clear()
      log('üë§ Checking provider info...', 'warning')
      
      try {
        // Get current user
        const { data: { user } } = await supabase.auth.getUser()
        
        if (!user) {
          log('‚ùå No user logged in!', 'error')
          return
        }
        
        log(`‚úÖ User ID: ${user.id}`, 'success')
        
        // Get provider info
        const { data: provider, error } = await supabase
          .from('providers_v2')
          .select('*')
          .eq('user_id', user.id)
          .single()
        
        if (error) {
          log(`‚ùå Provider Error: ${error.message}`, 'error')
          return
        }
        
        if (!provider) {
          log('‚ùå Provider not found!', 'error')
          return
        }
        
        log('\nüìä Provider Data:', 'warning')
        log(JSON.stringify({
          id: provider.id,
          user_id: provider.user_id,
          status: provider.status,
          is_available: provider.is_available
        }, null, 2))
        
        // Check if provider owns the job
        const { data: job } = await supabase
          .from('ride_requests')
          .select('provider_id')
          .eq('id', jobId)
          .single()
        
        if (job) {
          if (job.provider_id === provider.id) {
            log('\n‚úÖ Provider OWNS this job', 'success')
          } else {
            log(`\n‚ùå Provider does NOT own this job`, 'error')
            log(`Job provider_id: ${job.provider_id}`)
            log(`Current provider_id: ${provider.id}`)
          }
        }
        
      } catch (err) {
        log(`‚ùå Exception: ${err.message}`, 'error')
      }
    }
    
    async function checkStatusFlow() {
      clear()
      log('üîÑ Checking Status Flow Logic...', 'warning')
      
      try {
        const { data: job } = await supabase
          .from('ride_requests')
          .select('status')
          .eq('id', jobId)
          .single()
        
        if (!job) {
          log('‚ùå Job not found!', 'error')
          return
        }
        
        const currentStatus = job.status
        log(`Current Status: "${currentStatus}"`, 'success')
        
        // Test normalization
        const normalized = STATUS_ALIASES[currentStatus] || currentStatus
        log(`Normalized: "${normalized}"`)
        
        // Find in flow
        const currentIndex = STATUS_FLOW.findIndex(step => 
          step.dbStatus.includes(normalized) || step.key === normalized
        )
        
        log(`\nCurrent Index: ${currentIndex}`)
        
        if (currentIndex === -1) {
          log('\n‚ùå PROBLEM: Status not found in flow!', 'error')
          log('\nDebugging Info:', 'warning')
          log(`- Original status: "${currentStatus}"`)
          log(`- Normalized status: "${normalized}"`)
          log(`- Is in aliases? ${currentStatus in STATUS_ALIASES}`)
          log('\nAll available statuses:', 'warning')
          STATUS_FLOW.forEach((step, i) => {
            log(`${i}. ${step.key}:`)
            step.dbStatus.forEach(s => log(`   - "${s}"`))
          })
          return
        }
        
        log(`\n‚úÖ Status found at index ${currentIndex}`, 'success')
        
        const currentStep = STATUS_FLOW[currentIndex]
        log(`\nCurrent Step:`, 'warning')
        log(`- Key: ${currentStep.key}`)
        log(`- Label: ${currentStep.label}`)
        log(`- Icon: ${currentStep.icon}`)
        
        // Check next step
        const nextIndex = currentIndex + 1
        if (nextIndex < STATUS_FLOW.length) {
          const nextStep = STATUS_FLOW[nextIndex]
          log(`\n‚úÖ Next Step Available:`, 'success')
          log(`- Key: ${nextStep.key}`)
          log(`- Label: ${nextStep.label}`)
          log(`- Action Button Text: "${nextStep.action}"`)
          log(`- Next DB Status: "${nextStep.dbStatus[0]}"`)
          
          log(`\n‚úÖ Button SHOULD show: "${nextStep.action}"`, 'success')
        } else {
          log(`\n‚ö†Ô∏è No next step (job completed)`, 'warning')
          log(`‚úÖ Button should NOT show`, 'success')
        }
        
        // Check conditions
        log(`\nüìã Button Display Conditions:`, 'warning')
        log(`- canProgress: ${nextIndex < STATUS_FLOW.length}`)
        log(`- isCompleted: ${currentStatus === 'completed'}`)
        log(`- isCancelled: ${currentStatus === 'cancelled'}`)
        log(`- canUpdateStatus: ${nextIndex < STATUS_FLOW.length && currentStatus !== 'completed' && currentStatus !== 'cancelled'}`)
        
      } catch (err) {
        log(`‚ùå Exception: ${err.message}`, 'error')
      }
    }
    
    // Auto-run on load
    window.onload = () => {
      log('üöÄ Debug tool ready!', 'success')
      log('Click buttons above to check job status\n', 'warning')
    }
  </script>
</body>
</html>
