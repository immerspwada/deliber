<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Session Restore</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Session Restore - Thai Ride App</h1>
    
    <div class="test-case info">
        <h3>üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
        <ol>
            <li><strong>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö:</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <code>http://localhost:5173/login</code> ‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</li>
            <li><strong>‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <code>http://localhost:5173/customer</code></li>
            <li><strong>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä:</strong> ‡∏Å‡∏î F5 ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+R</li>
            <li><strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ <code>/customer</code> ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà <code>/login</code></li>
        </ol>
    </div>

    <div class="test-case">
        <h3>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Session ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
        <button class="btn-primary" onclick="checkCurrentSession()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Session</button>
        <div id="session-result"></div>
    </div>

    <div class="test-case">
        <h3>‚ö° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Router Guard Timing</h3>
        <button class="btn-warning" onclick="testRouterTiming()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Router Guard</button>
        <div id="router-result"></div>
    </div>

    <div class="test-case">
        <h3>üîÑ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Auto Refresh</h3>
        <button class="btn-success" onclick="testAutoRefresh()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Auto Refresh (10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</button>
        <div id="refresh-result"></div>
    </div>

    <div class="test-case">
        <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
        <div id="test-stats">
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
        </div>
    </div>

    <script>
        let testStats = {
            totalTests: 0,
            successfulRestores: 0,
            failedRestores: 0,
            averageRestoreTime: 0
        };

        function checkCurrentSession() {
            const result = document.getElementById('session-result');
            result.innerHTML = '<p>üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</p>';

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const currentUrl = window.location.href;
            const isOnCustomerPage = currentUrl.includes('/customer');
            const isOnLoginPage = currentUrl.includes('/login');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage/sessionStorage
            const hasLocalStorage = !!localStorage.getItem('supabase.auth.token');
            const hasSessionStorage = !!sessionStorage.getItem('demo_mode');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Supabase session (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            let supabaseSession = null;
            try {
                // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ Supabase session ‡πÉ‡∏ô localStorage
                const keys = Object.keys(localStorage);
                const supabaseKey = keys.find(key => key.includes('supabase') && key.includes('auth'));
                if (supabaseKey) {
                    supabaseSession = JSON.parse(localStorage.getItem(supabaseKey) || '{}');
                }
            } catch (e) {
                console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô Supabase session:', e);
            }

            const resultHtml = `
                <div class="${isOnCustomerPage ? 'success' : 'error'}">
                    <h4>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                    <p><strong>URL:</strong> ${currentUrl}</p>
                    <p><strong>‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${isOnCustomerPage ? '‚úÖ ‡πÉ‡∏ä‡πà' : '‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà'}</p>
                    <p><strong>‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô:</strong> ${isOnLoginPage ? '‚ö†Ô∏è ‡πÉ‡∏ä‡πà' : '‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà'}</p>
                    
                    <h4>üîê Session Data</h4>
                    <p><strong>localStorage Auth:</strong> ${hasLocalStorage ? '‚úÖ ‡∏°‡∏µ' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
                    <p><strong>sessionStorage Demo:</strong> ${hasSessionStorage ? '‚úÖ ‡∏°‡∏µ' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
                    <p><strong>Supabase Session:</strong> ${supabaseSession ? '‚úÖ ‡∏°‡∏µ' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
                    
                    ${supabaseSession ? `<pre>${JSON.stringify(supabaseSession, null, 2)}</pre>` : ''}
                </div>
            `;

            result.innerHTML = resultHtml;
        }

        function testRouterTiming() {
            const result = document.getElementById('router-result');
            result.innerHTML = '<p>‚è±Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Router Guard Timing...</p>';

            const startTime = Date.now();
            
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Router Guard
            const mockAuthCheck = () => {
                return new Promise((resolve) => {
                    // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà auth store ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ initialize
                    const mockInitTime = Math.random() * 4000 + 1000; // 1-5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    
                    setTimeout(() => {
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        
                        const isSuccess = duration < 5000; // Router Guard ‡∏£‡∏≠ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                        
                        resolve({
                            success: isSuccess,
                            duration: duration,
                            mockInitTime: mockInitTime
                        });
                    }, mockInitTime);
                });
            };

            mockAuthCheck().then(result => {
                const resultHtml = `
                    <div class="${result.success ? 'success' : 'error'}">
                        <h4>‚è±Ô∏è ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Router Timing</h4>
                        <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${result.duration}ms</p>
                        <p><strong>‡πÄ‡∏ß‡∏•‡∏≤ Mock Init:</strong> ${result.mockInitTime.toFixed(0)}ms</p>
                        <p><strong>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</strong> ${result.success ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô (< 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)' : '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (> 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)'}</p>
                        <p><strong>Router Guard Timeout:</strong> 5000ms</p>
                    </div>
                `;
                
                document.getElementById('router-result').innerHTML = resultHtml;
            });
        }

        function testAutoRefresh() {
            const result = document.getElementById('refresh-result');
            result.innerHTML = '<p>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Auto Refresh...</p>';

            let currentTest = 0;
            const totalTests = 10;
            let results = [];

            const runTest = () => {
                if (currentTest >= totalTests) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ
                    const successCount = results.filter(r => r.success).length;
                    const failCount = results.filter(r => !r.success).length;
                    const avgTime = results.reduce((sum, r) => sum + r.time, 0) / results.length;

                    testStats.totalTests += totalTests;
                    testStats.successfulRestores += successCount;
                    testStats.failedRestores += failCount;
                    testStats.averageRestoreTime = avgTime;

                    const summaryHtml = `
                        <div class="${successCount === totalTests ? 'success' : 'error'}">
                            <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Auto Refresh</h4>
                            <p><strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${totalTests} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                            <p><strong>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ${successCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${(successCount/totalTests*100).toFixed(1)}%)</p>
                            <p><strong>‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:</strong> ${failCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${(failCount/totalTests*100).toFixed(1)}%)</p>
                            <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</strong> ${avgTime.toFixed(0)}ms</p>
                            
                            <h5>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</h5>
                            <pre>${results.map((r, i) => 
                                `Test ${i+1}: ${r.success ? '‚úÖ' : '‚ùå'} ${r.time}ms`
                            ).join('\n')}</pre>
                        </div>
                    `;

                    result.innerHTML = summaryHtml;
                    updateTestStats();
                    return;
                }

                currentTest++;
                result.innerHTML = `<p>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${currentTest}/${totalTests}...</p>`;

                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£ refresh ‡πÅ‡∏•‡∏∞ session restore
                const startTime = Date.now();
                const mockRestoreTime = Math.random() * 3000 + 500; // 0.5-3.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

                setTimeout(() => {
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    const success = duration < 5000 && Math.random() > 0.1; // 90% success rate

                    results.push({
                        success: success,
                        time: duration
                    });

                    setTimeout(runTest, 100); // ‡∏£‡∏≠ 100ms ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                }, mockRestoreTime);
            };

            runTest();
        }

        function updateTestStats() {
            const stats = document.getElementById('test-stats');
            const successRate = testStats.totalTests > 0 ? 
                (testStats.successfulRestores / testStats.totalTests * 100).toFixed(1) : 0;

            stats.innerHTML = `
                <div class="info">
                    <h4>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                    <p><strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${testStats.totalTests} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <p><strong>Session Restore ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ${testStats.successfulRestores} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <p><strong>Session Restore ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:</strong> ${testStats.failedRestores} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <p><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ${successRate}%</p>
                    <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</strong> ${testStats.averageRestoreTime.toFixed(0)}ms</p>
                </div>
            `;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.onload = () => {
            checkCurrentSession();
        };
    </script>
</body>
</html>