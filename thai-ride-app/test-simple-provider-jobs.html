<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Simple Provider Jobs</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            padding: 20px; 
            background: #f8fafc;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 20px 0; 
            padding: 16px; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
        }
        .success { background: #f0fdf4; border-color: #22c55e; color: #15803d; }
        .error { background: #fef2f2; border-color: #ef4444; color: #dc2626; }
        .info { background: #f0f9ff; border-color: #3b82f6; color: #1d4ed8; }
        .warning { background: #fffbeb; border-color: #f59e0b; color: #d97706; }
        button { 
            padding: 10px 16px; 
            margin: 8px 8px 8px 0; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 500;
        }
        button:hover { background: #2563eb; }
        button.secondary { background: #6b7280; }
        button.secondary:hover { background: #4b5563; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        pre { 
            background: #f8fafc; 
            padding: 12px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-size: 13px;
            border: 1px solid #e2e8f0;
        }
        .log { 
            max-height: 300px; 
            overflow-y: auto; 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 12px; 
            border-radius: 6px; 
            font-family: 'SF Mono', Monaco, monospace; 
            font-size: 12px;
            line-height: 1.4;
        }
        .job-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .job-id {
            font-weight: 600;
            color: #1e293b;
        }
        .job-fare {
            font-weight: 700;
            color: #059669;
        }
        .job-route {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-connected { background: #dcfce7; color: #16a34a; }
        .status-error { background: #fee2e2; color: #dc2626; }
        .status-loading { background: #fef3c7; color: #d97706; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Simple Provider Jobs</h1>
        <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Provider Jobs ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)</p>
        
        <!-- Connection Status -->
        <div class="section">
            <h2>1. Connection Status</h2>
            <div id="connection-status" class="status-indicator status-loading">
                <span>‚è≥</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...
            </div>
            <button onclick="testConnection()">Test Connection</button>
        </div>

        <!-- Database Tests -->
        <div class="section">
            <h2>2. Database Tests</h2>
            <button onclick="testSimpleJobVisibility()">üß™ Test Simple RLS</button>
            <button onclick="checkPendingRides()">üìã Check Pending Rides</button>
            <button onclick="testSimpleFunction()">‚öôÔ∏è Test Simple Function</button>
            <div id="database-results"></div>
        </div>

        <!-- Create Test Data -->
        <div class="section">
            <h2>3. Test Data Management</h2>
            <button onclick="createTestRide()" class="success">‚ûï Create Test Ride</button>
            <button onclick="createMultipleTestRides()" class="success">‚ûï Create 3 Test Rides</button>
            <button onclick="clearTestData()" class="danger">üóëÔ∏è Clear Test Data</button>
            <div id="test-data-results"></div>
        </div>

        <!-- Available Jobs -->
        <div class="section">
            <h2>4. Available Jobs (Provider View)</h2>
            <button onclick="loadProviderJobs()">üîÑ Load Jobs</button>
            <button onclick="subscribeToJobs()">üì° Subscribe to Realtime</button>
            <button onclick="unsubscribeFromJobs()">üîá Unsubscribe</button>
            <div id="jobs-count">Jobs: <span id="job-count">0</span></div>
            <div id="jobs-list"></div>
        </div>

        <!-- Job Actions -->
        <div class="section">
            <h2>5. Job Actions</h2>
            <button onclick="acceptFirstJob()" class="success">‚úÖ Accept First Job</button>
            <div id="job-actions-results"></div>
        </div>

        <!-- Real-time Log -->
        <div class="section">
            <h2>6. Real-time Log</h2>
            <button onclick="clearLog()" class="secondary">Clear Log</button>
            <div id="realtime-log" class="log"></div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'http://127.0.0.1:54321'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        let realtimeChannel = null
        let availableJobs = []

        function log(message, type = 'info') {
            const logDiv = document.getElementById('realtime-log')
            const timestamp = new Date().toLocaleTimeString()
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'
            logDiv.innerHTML += `[${timestamp}] ${icon} ${message}\n`
            logDiv.scrollTop = logDiv.scrollHeight
            console.log(`[${type.toUpperCase()}]`, message)
        }

        function clearLog() {
            document.getElementById('realtime-log').innerHTML = ''
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status')
            statusEl.className = `status-indicator status-${status}`
            
            const icons = {
                connected: '‚úÖ',
                error: '‚ùå',
                loading: '‚è≥'
            }
            
            statusEl.innerHTML = `<span>${icons[status]}</span> ${message}`
        }

        async function testConnection() {
            updateConnectionStatus('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...')
            
            try {
                const { data, error } = await supabase.from('ride_requests').select('count').limit(1)
                if (error) throw error
                
                updateConnectionStatus('connected', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
                log('Database connection successful', 'success')
            } catch (error) {
                updateConnectionStatus('error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß')
                log(`Connection failed: ${error.message}`, 'error')
            }
        }

        async function testSimpleJobVisibility() {
            const resultDiv = document.getElementById('database-results')
            
            try {
                log('Testing simple job visibility...', 'info')
                
                const { data, error } = await supabase.rpc('test_simple_job_visibility')
                
                if (error) throw error

                let html = '<div class="success"><h4>üß™ Simple RLS Test Results:</h4>'
                data.forEach(test => {
                    const icon = test.result ? '‚úÖ' : '‚ùå'
                    html += `<p>${icon} <strong>${test.test_name}:</strong> ${test.message}</p>`
                })
                html += '</div>'

                resultDiv.innerHTML = html
                log('Simple RLS tests completed', 'success')
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
                log(`Simple RLS test failed: ${error.message}`, 'error')
            }
        }

        async function checkPendingRides() {
            const resultDiv = document.getElementById('database-results')
            
            try {
                log('Checking pending rides...', 'info')
                
                const { data, error } = await supabase
                    .from('ride_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .is('provider_id', null)
                    .order('created_at', { ascending: false })

                if (error) throw error

                let html = `<div class="info"><h4>üìã Pending Rides: ${data.length}</h4>`
                
                if (data.length > 0) {
                    data.forEach(ride => {
                        html += `
                            <div class="job-card">
                                <div class="job-header">
                                    <span class="job-id">${ride.tracking_id || ride.id}</span>
                                    <span class="job-fare">‡∏ø${ride.estimated_fare}</span>
                                </div>
                                <div class="job-route">
                                    üìç ${ride.pickup_address} ‚Üí üéØ ${ride.destination_address}
                                </div>
                                <small>Created: ${new Date(ride.created_at).toLocaleString('th-TH')}</small>
                            </div>
                        `
                    })
                } else {
                    html += '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>'
                }
                
                html += '</div>'
                resultDiv.innerHTML = html
                log(`Found ${data.length} pending rides`, 'success')
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
                log(`Check pending rides failed: ${error.message}`, 'error')
            }
        }

        async function testSimpleFunction() {
            const resultDiv = document.getElementById('database-results')
            
            try {
                log('Testing simple function...', 'info')
                
                const { data, error } = await supabase.rpc('get_all_pending_rides')
                
                if (error) throw error

                let html = `<div class="info"><h4>‚öôÔ∏è Simple Function Result: ${data.length} rides</h4>`
                
                if (data.length > 0) {
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>'
                } else {
                    html += '<p>Function returned no rides</p>'
                }
                
                html += '</div>'
                resultDiv.innerHTML = html
                log(`Simple function returned ${data.length} rides`, 'success')
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
                log(`Simple function test failed: ${error.message}`, 'error')
            }
        }

        async function createTestRide() {
            const resultDiv = document.getElementById('test-data-results')
            
            try {
                log('Creating test ride...', 'info')
                
                const testRide = {
                    user_id: '00000000-0000-0000-0000-000000000001',
                    tracking_id: `SIMPLE-TEST-${Date.now()}`,
                    pickup_lat: 13.7563,
                    pickup_lng: 100.5018,
                    pickup_address: '‡∏™‡∏¢‡∏≤‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏Å‡∏≠‡∏ô (Simple Test)',
                    destination_lat: 13.7467,
                    destination_lng: 100.5342,
                    destination_address: '‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå (Simple Test)',
                    estimated_fare: Math.floor(Math.random() * 200) + 100,
                    status: 'pending'
                }

                const { data, error } = await supabase
                    .from('ride_requests')
                    .insert(testRide)
                    .select()
                    .single()

                if (error) throw error

                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Test ride created successfully!
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `
                log(`Test ride created: ${data.tracking_id}`, 'success')
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
                log(`Create test ride failed: ${error.message}`, 'error')
            }
        }

        async function createMultipleTestRides() {
            const resultDiv = document.getElementById('test-data-results')
            
            try {
                log('Creating multiple test rides...', 'info')
                
                const testRides = []
                for (let i = 1; i <= 3; i++) {
                    testRides.push({
                        user_id: '00000000-0000-0000-0000-000000000001',
                        tracking_id: `SIMPLE-MULTI-${Date.now()}-${i}`,
                        pickup_lat: 13.7563 + (Math.random() - 0.5) * 0.01,
                        pickup_lng: 100.5018 + (Math.random() - 0.5) * 0.01,
                        pickup_address: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö ${i} (Simple Test)`,
                        destination_lat: 13.7467 + (Math.random() - 0.5) * 0.01,
                        destination_lng: 100.5342 + (Math.random() - 0.5) * 0.01,
                        destination_address: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á ${i} (Simple Test)`,
                        estimated_fare: Math.floor(Math.random() * 200) + 100,
                        status: 'pending'
                    })
                }

                const { data, error } = await supabase
                    .from('ride_requests')
                    .insert(testRides)
                    .select()

                if (error) throw error

                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ ${data.length} test rides created successfully!
                        <pre>${JSON.stringify(data.map(r => ({ id: r.id, tracking_id: r.tracking_id, fare: r.estimated_fare })), null, 2)}</pre>
                    </div>
                `
                log(`${data.length} test rides created`, 'success')
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
                log(`Create multiple test rides failed: ${error.message}`, 'error')
            }
        }

        async function clearTestData() {
            const resultDiv = document.getElementById('test-data-results')
            
            try {
                log('Clearing test data...', 'info')
                
                const { data, error } = await supabase
                    .from('ride_requests')
                    .delete()
                    .like('tracking_id', '%TEST%')
                    .select()

                if (error) throw error

                resultDiv.innerHTML = `
                    <div class="info">
                        üóëÔ∏è Cleared ${data.length} test rides
                    </div>
                `
                log(`Cleared ${data.length} test rides`, 'success')
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
                log(`Clear test data failed: ${error.message}`, 'error')
            }
        }

        async function loadProviderJobs() {
            try {
                log('Loading provider jobs...', 'info')
                
                const { data, error } = await supabase
                    .from('ride_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .is('provider_id', null)
                    .order('created_at', { ascending: false })
                    .limit(20)

                if (error) throw error

                availableJobs = data
                updateJobsList()
                log(`Loaded ${data.length} available jobs`, 'success')
            } catch (error) {
                log(`Load provider jobs failed: ${error.message}`, 'error')
            }
        }

        function updateJobsList() {
            document.getElementById('job-count').textContent = availableJobs.length
            
            const jobsList = document.getElementById('jobs-list')
            
            if (availableJobs.length === 0) {
                jobsList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</p>'
                return
            }
            
            let html = ''
            availableJobs.forEach(job => {
                html += `
                    <div class="job-card">
                        <div class="job-header">
                            <span class="job-id">${job.tracking_id || job.id}</span>
                            <span class="job-fare">‡∏ø${job.estimated_fare}</span>
                        </div>
                        <div class="job-route">
                            üìç ${job.pickup_address} ‚Üí üéØ ${job.destination_address}
                        </div>
                        <small>Created: ${new Date(job.created_at).toLocaleString('th-TH')}</small>
                        <button onclick="acceptJob('${job.id}')" class="success" style="margin-top: 8px;">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
                    </div>
                `
            })
            
            jobsList.innerHTML = html
        }

        async function subscribeToJobs() {
            if (realtimeChannel) {
                await supabase.removeChannel(realtimeChannel)
            }

            log('Subscribing to job updates...', 'info')
            
            realtimeChannel = supabase
                .channel('simple_test_jobs')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'ride_requests',
                        filter: 'status=eq.pending'
                    },
                    (payload) => {
                        const newJob = payload.new
                        log(`üÜï New job: ${newJob.tracking_id || newJob.id}`, 'success')
                        
                        if (!newJob.provider_id) {
                            availableJobs.unshift(newJob)
                            updateJobsList()
                        }
                    }
                )
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'ride_requests'
                    },
                    (payload) => {
                        const updated = payload.new
                        log(`üìù Job updated: ${updated.tracking_id || updated.id} -> ${updated.status}`, 'info')
                        
                        if (updated.status !== 'pending' || updated.provider_id) {
                            availableJobs = availableJobs.filter(j => j.id !== updated.id)
                            updateJobsList()
                        }
                    }
                )
                .subscribe((status) => {
                    log(`Realtime subscription: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning')
                })
        }

        async function unsubscribeFromJobs() {
            if (realtimeChannel) {
                await supabase.removeChannel(realtimeChannel)
                realtimeChannel = null
                log('Unsubscribed from job updates', 'info')
            }
        }

        async function acceptJob(jobId) {
            try {
                log(`Accepting job: ${jobId}`, 'info')
                
                // Simulate provider ID (in real app, get from providers_v2 table)
                const providerId = '00000000-0000-0000-0000-000000000002'
                
                const { data, error } = await supabase
                    .from('ride_requests')
                    .update({
                        provider_id: providerId,
                        status: 'accepted',
                        accepted_at: new Date().toISOString()
                    })
                    .eq('id', jobId)
                    .eq('status', 'pending')
                    .select()
                    .single()

                if (error) throw error

                if (data) {
                    log(`‚úÖ Job accepted: ${data.tracking_id || data.id}`, 'success')
                    document.getElementById('job-actions-results').innerHTML = `
                        <div class="success">
                            ‚úÖ Job accepted successfully!
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `
                } else {
                    log('‚ùå Job already taken or not found', 'error')
                }
            } catch (error) {
                log(`Accept job failed: ${error.message}`, 'error')
                document.getElementById('job-actions-results').innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                `
            }
        }

        async function acceptFirstJob() {
            if (availableJobs.length === 0) {
                log('No jobs available to accept', 'warning')
                return
            }
            
            await acceptJob(availableJobs[0].id)
        }

        // Auto-start connection test
        window.onload = () => {
            testConnection()
            log('Simple Provider Jobs Test initialized', 'success')
        }
    </script>
</body>
</html>