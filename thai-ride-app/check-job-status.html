<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check Job Status - Quick</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
      max-width: 800px;
      margin: 0 auto;
    }
    .result {
      background: #1e293b;
      padding: 20px;
      border: 2px solid #10b981;
      border-radius: 12px;
      margin: 20px 0;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    button {
      background: #10b981;
      color: #000;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px;
      margin: 10px 5px;
      transition: all 0.2s;
    }
    button:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    .error { color: #ef4444; }
    .success { color: #10b981; }
    .warning { color: #f59e0b; }
    .info { color: #3b82f6; }
    h1 { color: #10b981; }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-weight: bold;
      margin: 0 5px;
    }
    .status-matched { background: #10b981; color: #000; }
    .status-accepted { background: #3b82f6; color: #fff; }
    .status-arrived { background: #f59e0b; color: #000; }
  </style>
</head>
<body>
  <h1>üîç Quick Job Status Check</h1>
  <p>Job ID: <strong>7e011cf4-cc74-4eea-afc8-5dd4fb01c5a0</strong></p>
  
  <button onclick="checkStatus()">üöÄ Check Status NOW</button>
  
  <div id="result" class="result">Waiting...</div>

  <script>
    const SUPABASE_URL = 'https://yfqkqxqxqxqxqxqx.supabase.co' // Replace with your URL
    const SUPABASE_ANON_KEY = 'your-anon-key' // Replace with your key
    
    // Try to get from localStorage if available
    const savedUrl = localStorage.getItem('supabase_url')
    const savedKey = localStorage.getItem('supabase_key')
    
    const supabase = window.supabase.createClient(
      savedUrl || SUPABASE_URL,
      savedKey || SUPABASE_ANON_KEY
    )
    
    const jobId = '7e011cf4-cc74-4eea-afc8-5dd4fb01c5a0'
    
    function log(message, type = 'info') {
      const result = document.getElementById('result')
      const timestamp = new Date().toLocaleTimeString('th-TH')
      const icon = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      }[type] || '‚ÑπÔ∏è'
      
      result.innerHTML += `\n[${timestamp}] ${icon} <span class="${type}">${message}</span>`
      result.scrollTop = result.scrollHeight
    }
    
    function clear() {
      document.getElementById('result').innerHTML = ''
    }
    
    async function checkStatus() {
      clear()
      log('üîç Checking job status from database...', 'warning')
      
      try {
        const { data, error } = await supabase
          .from('ride_requests')
          .select('id, status, provider_id, user_id, created_at, updated_at')
          .eq('id', jobId)
          .single()
        
        if (error) {
          log(`‚ùå Database Error: ${error.message}`, 'error')
          log(`\n‚ÑπÔ∏è Hint: Check if Supabase URL and Key are correct`, 'warning')
          return
        }
        
        if (!data) {
          log('‚ùå Job not found in database!', 'error')
          return
        }
        
        log('‚úÖ Job found in database!', 'success')
        log('\nüìä JOB DATA:', 'info')
        log(`ID: ${data.id}`)
        log(`Status: ${data.status}`, 'success')
        log(`Provider ID: ${data.provider_id || 'null'}`)
        log(`User ID: ${data.user_id}`)
        log(`Created: ${new Date(data.created_at).toLocaleString('th-TH')}`)
        log(`Updated: ${data.updated_at ? new Date(data.updated_at).toLocaleString('th-TH') : 'null'}`)
        
        // Check status flow
        log('\nüîÑ STATUS FLOW ANALYSIS:', 'warning')
        
        const STATUS_FLOW = [
          { key: 'matched', dbStatus: ['matched', 'accepted', 'confirmed', 'offered'], action: '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' },
          { key: 'pickup', dbStatus: ['pickup', 'arrived', 'arriving', 'at_pickup'], action: '‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß' },
          { key: 'in_progress', dbStatus: ['in_progress', 'picked_up', 'ongoing', 'started'], action: '‡∏™‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' },
          { key: 'completed', dbStatus: ['completed', 'finished', 'done'], action: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' }
        ]
        
        const currentStatus = data.status
        const currentIndex = STATUS_FLOW.findIndex(step => 
          step.dbStatus.includes(currentStatus) || step.key === currentStatus
        )
        
        if (currentIndex === -1) {
          log(`‚ùå PROBLEM: Status "${currentStatus}" NOT FOUND in flow!`, 'error')
          log('\nüìã Available statuses:', 'info')
          STATUS_FLOW.forEach((step, i) => {
            log(`  ${i}. ${step.key}: ${step.dbStatus.join(', ')}`)
          })
        } else {
          log(`‚úÖ Status found at index ${currentIndex}`, 'success')
          log(`Current Step: ${STATUS_FLOW[currentIndex].key}`)
          
          if (currentIndex < STATUS_FLOW.length - 1) {
            const nextStep = STATUS_FLOW[currentIndex + 1]
            log(`\n‚úÖ NEXT STEP AVAILABLE:`, 'success')
            log(`  Button Text: "${STATUS_FLOW[currentIndex].action}"`)
            log(`  Next Status: ${nextStep.dbStatus[0]}`)
            log(`\nüéØ BUTTON SHOULD SHOW: "${STATUS_FLOW[currentIndex].action}"`, 'success')
          } else {
            log('\n‚ö†Ô∏è This is the last step (completed)', 'warning')
            log('‚úÖ Button should NOT show', 'success')
          }
        }
        
        // Check URL
        log('\nüîó URL CHECK:', 'info')
        const expectedURL = `http://localhost:5173/provider/job/${jobId}?status=${currentStatus}&step=${currentIndex}-${STATUS_FLOW[currentIndex]?.key || 'unknown'}`
        log(`Expected URL: ${expectedURL}`)
        
      } catch (err) {
        log(`‚ùå Exception: ${err.message}`, 'error')
        console.error(err)
      }
    }
    
    // Auto-run on load
    window.onload = () => {
      log('üöÄ Ready! Click button to check status', 'success')
    }
  </script>
</body>
</html>
