#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# 1. Lint
echo "üìù Linting..."
npm run lint || exit 1

# 2. Type check
echo "üî∑ Type checking..."
npm run type-check || exit 1

# 3. Tests
echo "üß™ Running tests..."
npm run test -- --run || exit 1

# 4. Check for secrets
echo "üîê Checking for secrets..."
if git diff --cached --name-only | xargs grep -l -E "(SUPABASE_SERVICE_ROLE|sk_live_|password\s*=)" 2>/dev/null; then
  echo "‚ùå Potential secrets detected! Please remove before committing."
  exit 1
fi

# 5. Validate SQL migrations (if any staged)
if git diff --cached --name-only | grep -q "\.sql$"; then
  echo "üóÑÔ∏è SQL files detected - validating..."
  
  # Check for RLS in new tables
  for file in $(git diff --cached --name-only | grep "\.sql$"); do
    if grep -q "CREATE TABLE" "$file" && ! grep -q "ENABLE ROW LEVEL SECURITY" "$file"; then
      echo "‚ö†Ô∏è Warning: $file creates table without RLS. Consider adding RLS policies."
    fi
    
    if grep -q "CREATE TABLE" "$file" && ! grep -q "CREATE POLICY" "$file"; then
      echo "‚ö†Ô∏è Warning: $file creates table without policies. Add RLS policies for security."
    fi
  done
fi

echo "‚úÖ All pre-commit checks passed!"
