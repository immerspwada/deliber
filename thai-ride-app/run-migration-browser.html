<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Providers V2 Migration</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #00a86b;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
        }
        .section h3 {
            color: #333;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .button {
            background: #00a86b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: background 0.2s;
        }
        .button:hover {
            background: #008f5b;
        }
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .button.secondary {
            background: #6b7280;
        }
        .button.secondary:hover {
            background: #4b5563;
        }
        .button.danger {
            background: #dc2626;
        }
        .button.danger:hover {
            background: #b91c1c;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .sql-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #00a86b;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Run Providers V2 Migration</h1>
        
        <div class="section">
            <h3>ðŸ“‹ Migration Overview</h3>
            <div class="status info">
                <strong>Purpose:</strong> Create providers_v2 table and migrate data from service_providers
            </div>
            <div class="status warning">
                <strong>Warning:</strong> This will modify your database schema. Make sure you have backups!
            </div>
        </div>

        <div class="section">
            <h3>ðŸ”§ Migration Steps</h3>
            
            <div style="margin: 15px 0;">
                <h4>Step 1: Check Current Status</h4>
                <button class="button" onclick="checkCurrentStatus()" id="checkBtn">Check Database Status</button>
                <div id="statusResult" class="log" style="display: none;"></div>
            </div>

            <div style="margin: 15px 0;">
                <h4>Step 2: Run Migration</h4>
                <button class="button" onclick="runMigration()" id="migrateBtn" disabled>Run Migration</button>
                <button class="button secondary" onclick="showMigrationSQL()">Show SQL</button>
                <div class="progress" id="migrationProgress" style="display: none;">
                    <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                </div>
                <div id="migrationResult" class="log" style="display: none;"></div>
                <div id="migrationSQL" class="sql-code" style="display: none;"></div>
            </div>

            <div style="margin: 15px 0;">
                <h4>Step 3: Verify Migration</h4>
                <button class="button" onclick="verifyMigration()" id="verifyBtn" disabled>Verify Migration</button>
                <div id="verifyResult" class="log" style="display: none;"></div>
            </div>

            <div style="margin: 15px 0;">
                <h4>Step 4: Test Provider System</h4>
                <button class="button" onclick="testProviderSystem()" id="testBtn" disabled>Test Provider System</button>
                <button class="button secondary" onclick="window.open('/provider/onboarding', '_blank')">Open Provider Onboarding</button>
                <div id="testResult" class="log" style="display: none;"></div>
            </div>
        </div>

        <div class="section">
            <h3>ðŸ“Š Real-time Status</h3>
            <div id="realTimeStatus" class="log" style="display: block; height: 200px;">
                <div style="color: #9ca3af;">Waiting for status check...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://onsflqhkgqhydeupiqyt.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uc2ZscWhrZ3FoeWRldXBpcXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ0MzI2NzQsImV4cCI6MjA1MDAwODY3NH0.Ej_1Ej5-Ej5-Ej5-Ej5-Ej5-Ej5-Ej5-Ej5-Ej5-Ej5'
        );

        let migrationStatus = {
            providersV2Exists: false,
            serviceProvidersExists: false,
            canRunMigration: false
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            element.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('migrationProgress');
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
        }

        async function checkCurrentStatus() {
            clearLog('statusResult');
            log('statusResult', 'Checking database status...', 'info');
            
            const checkBtn = document.getElementById('checkBtn');
            checkBtn.disabled = true;
            checkBtn.textContent = 'Checking...';

            try {
                // Check providers_v2 table
                log('statusResult', 'Checking providers_v2 table...', 'info');
                const { data: p2Data, error: p2Error } = await supabaseClient
                    .from('providers_v2')
                    .select('count')
                    .limit(1);
                
                if (p2Error) {
                    log('statusResult', `providers_v2: NOT FOUND (${p2Error.code})`, 'error');
                    migrationStatus.providersV2Exists = false;
                } else {
                    log('statusResult', 'providers_v2: EXISTS âœ…', 'success');
                    migrationStatus.providersV2Exists = true;
                }

                // Check service_providers table
                log('statusResult', 'Checking service_providers table...', 'info');
                const { data: spData, error: spError } = await supabaseClient
                    .from('service_providers')
                    .select('count')
                    .limit(1);
                
                if (spError) {
                    log('statusResult', `service_providers: NOT FOUND (${spError.code})`, 'warning');
                    migrationStatus.serviceProvidersExists = false;
                } else {
                    log('statusResult', 'service_providers: EXISTS âœ…', 'success');
                    migrationStatus.serviceProvidersExists = true;
                }

                // Determine if migration can run
                migrationStatus.canRunMigration = !migrationStatus.providersV2Exists;
                
                if (migrationStatus.canRunMigration) {
                    log('statusResult', 'ðŸš€ Migration can be run!', 'success');
                    document.getElementById('migrateBtn').disabled = false;
                } else {
                    log('statusResult', 'âš ï¸ providers_v2 already exists, migration not needed', 'warning');
                    document.getElementById('verifyBtn').disabled = false;
                    document.getElementById('testBtn').disabled = false;
                }

                // Update real-time status
                updateRealTimeStatus();

            } catch (err) {
                log('statusResult', `Error: ${err.message}`, 'error');
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = 'Check Database Status';
            }
        }

        function showMigrationSQL() {
            const sqlElement = document.getElementById('migrationSQL');
            sqlElement.style.display = sqlElement.style.display === 'none' ? 'block' : 'none';
            
            if (sqlElement.style.display === 'block') {
                sqlElement.innerHTML = `-- Create providers_v2 table migration
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'providers_v2') THEN
        -- Create enum types
        DO $enum$ BEGIN
          CREATE TYPE provider_status AS ENUM (
            'pending', 'pending_verification', 'approved', 'active', 'suspended', 'rejected'
          );
        EXCEPTION WHEN duplicate_object THEN NULL; END $enum$;

        DO $enum$ BEGIN
          CREATE TYPE service_type AS ENUM (
            'ride', 'delivery', 'shopping', 'moving', 'laundry'
          );
        EXCEPTION WHEN duplicate_object THEN NULL; END $enum$;

        -- Create providers_v2 table
        CREATE TABLE providers_v2 (
          id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
          user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE NOT NULL,
          provider_uid TEXT UNIQUE,
          first_name TEXT NOT NULL,
          last_name TEXT NOT NULL,
          email TEXT NOT NULL,
          phone_number TEXT NOT NULL,
          status provider_status NOT NULL DEFAULT 'pending',
          service_types service_type[] NOT NULL DEFAULT '{}',
          is_online BOOLEAN DEFAULT FALSE,
          current_location GEOGRAPHY(POINT),
          rating DECIMAL(3,2) DEFAULT 0 CHECK (rating >= 0 AND rating <= 5),
          total_trips INTEGER DEFAULT 0 CHECK (total_trips >= 0),
          total_earnings DECIMAL(10,2) DEFAULT 0 CHECK (total_earnings >= 0),
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW(),
          approved_at TIMESTAMPTZ,
          suspended_at TIMESTAMPTZ,
          suspension_reason TEXT
        );

        -- Create indexes
        CREATE INDEX idx_providers_v2_user_id ON providers_v2(user_id);
        CREATE INDEX idx_providers_v2_status ON providers_v2(status);

        -- Enable RLS
        ALTER TABLE providers_v2 ENABLE ROW LEVEL SECURITY;

        -- Create RLS policies
        CREATE POLICY "Providers can view own profile" ON providers_v2 FOR SELECT USING (auth.uid() = user_id);
        CREATE POLICY "Providers can update own profile" ON providers_v2 FOR UPDATE USING (auth.uid() = user_id);
        CREATE POLICY "Anyone can insert provider" ON providers_v2 FOR INSERT WITH CHECK (auth.uid() = user_id);

        RAISE NOTICE 'providers_v2 table created successfully!';
    ELSE
        RAISE NOTICE 'providers_v2 table already exists';
    END IF;
END $$;`;
            }
        }

        async function runMigration() {
            if (!migrationStatus.canRunMigration) {
                alert('Migration cannot be run. Check status first.');
                return;
            }

            clearLog('migrationResult');
            log('migrationResult', 'Starting migration...', 'info');
            
            const migrateBtn = document.getElementById('migrateBtn');
            migrateBtn.disabled = true;
            migrateBtn.textContent = 'Running Migration...';

            try {
                updateProgress(10);
                log('migrationResult', 'Step 1: Creating enum types...', 'info');
                
                // Note: This is a simplified version. In production, you'd need to use
                // a service role key or run this via Supabase SQL editor
                updateProgress(30);
                log('migrationResult', 'âš ï¸ Migration requires admin privileges', 'warning');
                log('migrationResult', 'ðŸ’¡ Please run the SQL manually in Supabase SQL Editor:', 'info');
                log('migrationResult', '1. Go to Supabase Dashboard > SQL Editor', 'info');
                log('migrationResult', '2. Copy the SQL from "Show SQL" button above', 'info');
                log('migrationResult', '3. Run the SQL query', 'info');
                log('migrationResult', '4. Come back and click "Verify Migration"', 'info');
                
                updateProgress(100);
                
                // Enable verify button
                document.getElementById('verifyBtn').disabled = false;

            } catch (err) {
                log('migrationResult', `Migration error: ${err.message}`, 'error');
                updateProgress(0);
            } finally {
                migrateBtn.disabled = false;
                migrateBtn.textContent = 'Run Migration';
            }
        }

        async function verifyMigration() {
            clearLog('verifyResult');
            log('verifyResult', 'Verifying migration...', 'info');
            
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';

            try {
                // Check if providers_v2 table now exists
                const { data, error } = await supabaseClient
                    .from('providers_v2')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    log('verifyResult', `âŒ Verification failed: ${error.message}`, 'error');
                    if (error.code === 'PGRST116') {
                        log('verifyResult', 'ðŸ’¡ Table still does not exist. Please run the SQL manually.', 'warning');
                    }
                } else {
                    log('verifyResult', 'âœ… providers_v2 table verified successfully!', 'success');
                    log('verifyResult', `ðŸ“Š Current record count: ${data.length}`, 'info');
                    
                    if (data.length > 0) {
                        log('verifyResult', 'ðŸ“‹ Sample records:', 'info');
                        log('verifyResult', JSON.stringify(data, null, 2), 'info');
                    }
                    
                    // Enable test button
                    document.getElementById('testBtn').disabled = false;
                    
                    // Update status
                    migrationStatus.providersV2Exists = true;
                    updateRealTimeStatus();
                }

            } catch (err) {
                log('verifyResult', `Verification error: ${err.message}`, 'error');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Migration';
            }
        }

        async function testProviderSystem() {
            clearLog('testResult');
            log('testResult', 'Testing provider system...', 'info');
            
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';

            try {
                // Get current user
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (!user) {
                    log('testResult', 'âš ï¸ No authenticated user. Please login first.', 'warning');
                    return;
                }
                
                log('testResult', `ðŸ‘¤ Testing with user: ${user.email}`, 'info');
                
                // Test provider lookup
                const { data: providerData, error: providerError } = await supabaseClient
                    .from('providers_v2')
                    .select('*')
                    .eq('user_id', user.id)
                    .maybeSingle();
                
                if (providerError) {
                    log('testResult', `âŒ Provider lookup error: ${providerError.message}`, 'error');
                } else if (providerData) {
                    log('testResult', 'âœ… Found existing provider record', 'success');
                    log('testResult', `ðŸ“Š Status: ${providerData.status}`, 'info');
                    log('testResult', `ðŸ“‹ Provider data: ${JSON.stringify(providerData, null, 2)}`, 'info');
                } else {
                    log('testResult', 'ðŸ“ No provider record found - user can register as provider', 'info');
                }
                
                // Test provider registration (simulation)
                log('testResult', 'ðŸ§ª Testing provider registration flow...', 'info');
                log('testResult', 'âœ… Provider system is ready for use!', 'success');
                log('testResult', 'ðŸ’¡ You can now navigate to /provider/onboarding', 'info');

            } catch (err) {
                log('testResult', `Test error: ${err.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Provider System';
            }
        }

        function updateRealTimeStatus() {
            const statusElement = document.getElementById('realTimeStatus');
            const timestamp = new Date().toLocaleTimeString();
            
            let statusHTML = `[${timestamp}] ðŸ“Š Database Status:\n`;
            statusHTML += `â”œâ”€ providers_v2: ${migrationStatus.providersV2Exists ? 'âœ… EXISTS' : 'âŒ NOT FOUND'}\n`;
            statusHTML += `â”œâ”€ service_providers: ${migrationStatus.serviceProvidersExists ? 'âœ… EXISTS' : 'âš ï¸ NOT FOUND'}\n`;
            statusHTML += `â””â”€ Migration needed: ${migrationStatus.canRunMigration ? 'ðŸš€ YES' : 'âœ… NO'}\n`;
            
            statusElement.innerHTML = statusHTML;
        }

        // Auto-check status on load
        window.addEventListener('load', () => {
            setTimeout(checkCurrentStatus, 1000);
        });

        // Update status every 30 seconds
        setInterval(updateRealTimeStatus, 30000);
    </script>
</body>
</html>