#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check for potential secrets/credentials in staged files
echo "üîç Checking for potential secrets..."

# Patterns to detect
PATTERNS=(
  "supabase\.co.*eyJ"
  "VITE_SUPABASE_ANON_KEY=eyJ"
  "supabaseAnonKey.*=.*eyJ"
  "password.*=.*['\"][^'\"]{8,}"
  "api[_-]?key.*=.*['\"][^'\"]{20,}"
  "secret.*=.*['\"][^'\"]{20,}"
  "token.*=.*eyJ"
)

# Files to check (staged files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js|vue|json|env)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No relevant files to check"
  exit 0
fi

FOUND_SECRETS=0

for pattern in "${PATTERNS[@]}"; do
  MATCHES=$(echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null || true)
  if [ -n "$MATCHES" ]; then
    echo "‚ö†Ô∏è  Potential secret found matching pattern: $pattern"
    echo "   In files: $MATCHES"
    FOUND_SECRETS=1
  fi
done

# Check for hardcoded Supabase URLs with keys
SUPABASE_MATCHES=$(echo "$STAGED_FILES" | xargs grep -l "onsflqhkgqhydeupiqyt" 2>/dev/null || true)
if [ -n "$SUPABASE_MATCHES" ]; then
  # Check if it's in a .env file (allowed) or source code (not allowed)
  for file in $SUPABASE_MATCHES; do
    if [[ ! "$file" =~ \.env ]]; then
      echo "‚ö†Ô∏è  Hardcoded Supabase project reference found in: $file"
      FOUND_SECRETS=1
    fi
  done
fi

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "‚ùå Commit blocked: Potential secrets detected!"
  echo "   Please remove credentials and use environment variables instead."
  echo "   If this is a false positive, use: git commit --no-verify"
  exit 1
fi

echo "‚úÖ No secrets detected"

# Run lint-staged if available
if [ -f "thai-ride-app/node_modules/.bin/lint-staged" ]; then
  cd thai-ride-app && npx lint-staged
fi
